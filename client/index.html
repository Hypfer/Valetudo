<!DOCTYPE html>
<html>
<head>
    <link rel="stylesheet" href="css/onsenui.css">
    <link rel="stylesheet" href="css/onsen-css-components.min.css">
    <link rel="manifest" href="/manifest.json">
    <script src="js/onsenui.min.js"></script>
    <script src="js/geometry-polyfill.js"></script>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#4285f4">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="icon" sizes="192x192" href="icon.png">
    <title>Mi Robot Vacuum</title>
</head>
<body>
    <script>
        window.fn = {};

        window.fn.toggleMenu = function () {
            document.getElementById('appSplitter').left.toggle();
        };

        window.fn.loadView = function (index) {
            document.getElementById('appTabbar').setActiveTab(index);
            document.getElementById('sidemenu').close();
        };

        window.fn.loadLink = function (url) {
            window.open(url, '_blank');
        };

        window.fn.pushPage = function (page, anim) {
            if (anim) {
                document.getElementById('appNavigator').pushPage(page.id, { data: { title: page.title }, animation: anim });
            } else {
                document.getElementById('appNavigator').pushPage(page.id, { data: { title: page.title } });
            }
            history.pushState({}, page.title);
        };

        window.fn.request = function (url, method, callback) {
            var request = new XMLHttpRequest();
            request.open(method, url, true);

            request.onload = function () {
                if (request.status >= 200 && request.status < 400) {
                    callback(null, JSON.parse(request.responseText));
                } else {
                    console.error(request);
                    callback("There was an error: " + request.status);
                }
            };

            request.onerror = function () {
                callback("Connection error");
            };

            request.send();
        };

        window.fn.requestWithPayload = function (url, payload, method, callback) {
            var request = new XMLHttpRequest();
            request.open(method, url, true);
            request.setRequestHeader('Content-Type', 'application/json; charset=UTF-8');
            request.send(payload);

            request.onload = function () {
                if (request.status >= 200 && request.status < 400) {
                    callback(null, JSON.parse(request.responseText));
                } else {
                    console.error(request);
                    callback("There was an error: " + request.status);
                }
            };

            request.onerror = function () {
                callback("Connection error");
            };
        };

        window.fn.secondsToHms = function (d) {
            d = Number(d);

            var h = Math.floor(d / 3600);
            var m = Math.floor(d % 3600 / 60);
            var s = Math.floor(d % 3600 % 60);

            return ('0' + h).slice(-2) + ":" + ('0' + m).slice(-2) + ":" + ('0' + s).slice(-2);
        };

        //TODO: Fix this routing mess
        ons.ready(function () {
            window.addEventListener('popstate', function (e) {
                e.preventDefault();
                document.getElementById('appNavigator').popPage({});
                history.pushState(null, null, window.location.pathname); //What
                //this is just broken
            }, false);
        });

        if (ons.platform.isIPhoneX()) {
            document.documentElement.setAttribute('onsflag-iphonex-portrait', '');
        }

    </script>
    <ons-navigator id="appNavigator" swipeable swipe-target-width="80px">
        <ons-page>
            <ons-splitter id="appSplitter">
                <ons-splitter-side id="sidemenu" page="sidemenu.html" swipeable side="left" collapse="" width="260px"></ons-splitter-side>
                <ons-splitter-content page="tabbar.html"></ons-splitter-content>
            </ons-splitter>
        </ons-page>
    </ons-navigator>

    <template id="tabbar.html">
        <ons-page id="tabbar-page">
            <ons-toolbar>
                <div class="left">
                    <ons-toolbar-button onclick="fn.toggleMenu()">
                        <ons-icon icon="ion-navicon, material:md-menu"></ons-icon>
                    </ons-toolbar-button>
                </div>
                <div class="center">Home</div>
            </ons-toolbar>
            <ons-tabbar swipeable id="appTabbar" position="auto">
                <ons-tab label="Home" icon="ion-home" page="home.html" active></ons-tab>
                <ons-tab label="Map" icon="fa-map-marker" page="map.html"></ons-tab>
                <ons-tab label="Zones" icon="fa-share-square" page="zones.html"></ons-tab>
                <ons-tab label="ManualControl" icon="fa-gamepad" page="manualcontrol.html"></ons-tab>
                <ons-tab label="Settings" icon="fa-cog" page="settings.html"></ons-tab>
            </ons-tabbar>

            <script>
                ons.getScriptPage().addEventListener('prechange', function (event) {
                    if (event.target.matches('#appTabbar')) {
                        event.currentTarget.querySelector('ons-toolbar .center').innerHTML = event.tabItem.getAttribute('label');
                    }
                });
            </script>
        </ons-page>
    </template>

    <template id="sidemenu.html">
        <ons-page>
            <div class="profile-header">
                <span>Valetudo</span>
            </div>
            <ons-list>
                <ons-list-item onclick="fn.loadView(0)">
                    <div class="left">
                        <ons-icon fixed-width class="list-item__icon" icon="ion-home, material:md-home"></ons-icon>
                    </div>
                    <div class="center">
                        Home
                    </div>
                    <div class="right">
                        <ons-icon icon="fa-link"></ons-icon>
                    </div>
                </ons-list-item>
                <ons-list-item onclick="fn.loadView(1)">
                    <div class="left">
                        <ons-icon fixed-width class="list-item__icon" icon="fa-map-marker, material:fa-map-marker"></ons-icon>
                    </div>
                    <div class="center">
                        Map
                    </div>
                    <div class="right">
                        <ons-icon icon="fa-link"></ons-icon>
                    </div>
                </ons-list-item>
                <ons-list-item onclick="fn.loadView(2)">
                    <div class="left">
                        <ons-icon fixed-width class="list-item__icon" icon="fa-share-square, material:fa-share-square"></ons-icon>
                    </div>
                    <div class="center">
                        Zones
                    </div>
                    <div class="right">
                        <ons-icon icon="fa-link"></ons-icon>
                    </div>
                </ons-list-item>
                <ons-list-item onclick="fn.loadView(3)">
                        <div class="left">
                            <ons-icon fixed-width class="list-item__icon" icon="fa-gamepad, material:fa-gamepad"></ons-icon>
                        </div>
                        <div class="center">
                            Manual Control
                        </div>
                        <div class="right">
                            <ons-icon icon="fa-link"></ons-icon>
                        </div>
                    </ons-list-item>
                <ons-list-item onclick="fn.loadView(4)">
                    <div class="left">
                        <ons-icon fixed-width class="list-item__icon" icon="fa-cog, material: md-settings"></ons-icon>
                    </div>
                    <div class="center">
                        Settings
                    </div>
                    <div class="right">
                        <ons-icon icon="fa-link"></ons-icon>
                    </div>
                </ons-list-item>
            </ons-list>

            <ons-list-title style="margin-top: 10px">Links</ons-list-title>
            <ons-list>
                <ons-list-item onclick="fn.loadLink('https://github.com/Hypfer/Valetudo')">
                    <div class="left">
                        <ons-icon fixed-width class="list-item__icon" icon="ion-social-github"></ons-icon>
                    </div>
                    <div class="center">
                        GitHub
                    </div>
                    <div class="right">
                        <ons-icon icon="fa-external-link"></ons-icon>
                    </div>
                </ons-list-item>
                <ons-list-item onclick="fn.loadLink('https://www.paypal.com/cgi-bin/webscr?cmd=_s-xclick&hosted_button_id=JQNCDGJ3FBCM6')">
                    <div class="left">
                        <ons-icon fixed-width class="list-item__icon" icon="fa-paypal"></ons-icon>
                    </div>
                    <div class="center">
                        Donate
                    </div>
                    <div class="right">
                        <ons-icon icon="fa-external-link"></ons-icon>
                    </div>
                </ons-list-item>
                <ons-list-item onclick="fn.pushPage({'id': 'about.html', 'title': 'About'})">
                    <div class="left">
                        <ons-icon fixed-width class="list-item__icon" icon="fa-info-circle"></ons-icon>
                    </div>
                    <div class="center">
                        About
                    </div>
                    <div class="right">
                        <ons-icon icon="fa-link"></ons-icon>
                    </div>
                </ons-list-item>
            </ons-list>

            <script>
                ons.getScriptPage().onInit = function () {
                    // Set ons-splitter-side animation
                    this.parentElement.setAttribute('animation', ons.platform.isAndroid() ? 'overlay' : 'reveal');
                };
            </script>

            <style>
                .profile-header {
                    width: 200px;
                    margin: 10px auto 10px;
                    text-align: center;
                    font-size: 2em;
                    font-weight: bolder;
                }

                    .profile-header > span {
                        display: block;
                        max-width: 100%;
                    }

                ons-list-item {
                    color: #444;
                }
            </style>
        </ons-page>
    </template>

    <template id="home.html">
        <ons-page>
            <ons-progress-bar id="loading-bar-home" value="0" indeterminate="indeterminate"></ons-progress-bar>
            <section>
                <p id="robot-state">
                    Loading state...
                </p>
                <div style="width:100%; text-align:center;">
                    <p id="robot-state-details">
                        <span id="robot-state-details-m2">Area: ???.?? m²</span>
                        <span id="robot-state-details-time">Time: ??:??:??</span>
                    </p>
                </div>
            </section>
            <hr style="width:98%; opacity: 0.3">

            <section id="robot-control-buttons">
                <ons-button id="start-button" class="button-margin" onclick="handleControlButton('start')" disabled style="width:40%"><ons-icon icon="fa-play"></ons-icon> Start</ons-button>
                <ons-button id="pause-button" class="button-margin" onclick="handleControlButton('pause')" disabled style="width:40%"><ons-icon icon="fa-pause"></ons-icon> Pause</ons-button>
                <br>
                <ons-button id="stop-button" class="button-margin" onclick="handleControlButton('stop')" disabled style="width:40%"><ons-icon icon="fa-stop"></ons-icon> Stop</ons-button>
                <ons-button id="home-button" class="button-margin" onclick="handleControlButton('home')" disabled style="width:40%"><ons-icon icon="fa-home"></ons-icon> Home</ons-button>
                <br>
                <ons-button id="spot-button" class="button-margin" onclick="handleControlButton('spot')" disabled style="width:40%"><ons-icon icon="fa-caret-down"></ons-icon> Spot</ons-button>
                <ons-button id="find-robot-button" class="button-margin" onclick="handleControlButton('find')" disabled style="width:40%"><ons-icon icon="fa-map-marker"></ons-icon> Find</ons-button>
                <br>
                <ons-button id="go-to-button" class="button-margin" onclick="handleGoToButton()" disabled style="width:40%"><ons-icon icon="fa-map-signs"></ons-icon> Go to </ons-button>
                <ons-button id="area-button" class="button-margin" onclick="handleAreaButton()" disabled style="width:40%"><ons-icon icon="fa-map"></ons-icon> Area </ons-button>

                <br>
                <ons-button id="fanspeed-button" class="button-margin" onclick="handleFanspeedButton()" disabled style="width:40%"><ons-icon icon="fa-superpowers"></ons-icon> Unknown power</ons-button>
            </section>
            <hr style="width:98%; opacity: 0.3">

            <section style="margin: 10px 16px">
                <p id="battery-status-text">
                    Battery: ??%
                </p>

                <p>
                    <ons-progress-bar id="battery-status-bar" secondary-value="100"></ons-progress-bar>
                </p>
            </section>


            <script>
                var currentRefreshTimer;

                var fanspeeds = {
                    38: "Low power",
                    60: "Medium Power",
                    75: "High power",
                    100: "Super power"
                };

                var startButton = document.getElementById("start-button");
                var pauseButton = document.getElementById("pause-button");
                var stopButton = document.getElementById("stop-button");
                var spotButton = document.getElementById("spot-button");
                var goToButton = document.getElementById("go-to-button");
                var areaButton = document.getElementById("area-button");
                var fanspeedButton = document.getElementById("fanspeed-button");
                var findRobotButton = document.getElementById("find-robot-button");
                var homeButton = document.getElementById("home-button");
                var batteryStatusText = document.getElementById('battery-status-text');
                var batteryStatusBar = document.getElementById('battery-status-bar');
                var robotState = document.getElementById('robot-state');
                var robotStateDetailsM2 = document.getElementById("robot-state-details-m2");
                var robotStateDetailsTime = document.getElementById("robot-state-details-time");
                var loadingBarHome = document.getElementById('loading-bar-home');

                var config = {};

                var BUTTONS = {
                    "start": {
                        button: startButton,
                        url: "api/start_cleaning"
                    },
                    "pause": {
                        button: pauseButton,
                        url: "api/pause_cleaning"
                    },
                    "stop": {
                        button: stopButton,
                        url: "api/stop_cleaning"
                    },
                    "home": {
                        button: homeButton,
                        url: "api/drive_home"
                    },
                    "find": {
                        button: findRobotButton,
                        url: "api/find_robot"
                    },
                    "spot": {
                        button: spotButton,
                        url: "api/spot_clean"
                    }
                };

                if (!ons.platform.isAndroid()) {
                    var progressStyle = document.querySelectorAll('.progressStyle');
                    for (progress of progressStyle) { //How Why Help
                        progress.hasAttribute('modifier') ?
                            progress.setAttribute('modifier', progress.getAttribute('modifier') + ' ios') :
                            progress.setAttribute('modifier', 'ios');
                    }
                }

                function handleControlButton(button) {
                    var btn = BUTTONS[button];
                    if (btn === undefined) {
                        throw new Error("Invalid button");
                    } else {
                        btn.button.setAttribute("disabled", "disabled");

                        loadingBarHome.setAttribute("indeterminate", "indeterminate");
                        fn.request(btn.url, "PUT", function (err) {
                            if (err) {
                                btn.button.removeAttribute("disabled");
                                loadingBarHome.removeAttribute("indeterminate");
                                ons.notification.toast(err, { buttonLabel: 'Dismiss', timeout: 1500 })
                            } else {
                                window.clearTimeout(currentRefreshTimer);
                                window.setTimeout(function () {
                                    updateHomePage();
                                }, 500);
                            }
                        })
                    }
                }

                function handleFanspeedButton() {
                    window.clearTimeout(currentRefreshTimer);

                    ons.openActionSheet({
                        title: 'Select fan speed',
                        cancelable: true,
                        buttons: [
                            'Low power',
                            'Medium power',
                            "High power",
                            "Super power",
                            {
                                label: 'Cancel',
                                icon: 'md-close'
                            }
                        ]
                    }).then(function (index) {
                        var level;

                        switch (index) {
                            case 0:
                                level = 38;
                                break;
                            case 1:
                                level = 60;
                                break;
                            case 2:
                                level = 75;
                                break;
                            case 3:
                                level = 100;
                                break;
                        }

                        if (level) {
                            loadingBarHome.setAttribute("indeterminate", "indeterminate");
                            fanspeedButton.setAttribute("disabled", "disabled");
                            fn.requestWithPayload("api/fanspeed", JSON.stringify({ speed: level }), "PUT", function (err, res) {
                                if (err) {
                                    fanspeedButton.removeAttribute("disabled");
                                    loadingBarHome.removeAttribute("indeterminate");
                                    ons.notification.toast(err, { buttonLabel: 'Dismiss', timeout: 1500 })
                                } else {
                                    window.clearTimeout(currentRefreshTimer);
                                    window.setTimeout(function () {
                                        updateHomePage();
                                    }, 150);
                                }
                            })
                        } else {
                            window.setTimeout(function () {
                                updateHomePage();
                            }, 3000);
                        }
                    });
                }

                function handleGoToButton() {
                    window.clearTimeout(currentRefreshTimer);
                    var options = []

                    for(var i=0; i < config.spots.length; i++){
                        options.push(config.spots[i][0]);
                    }

                    options.push({
                                label: 'Cancel',
                                icon: 'md-close'
                            });

                    ons.openActionSheet({
                        title: 'Go to',
                        cancelable: true,
                        buttons: options
                    }).then(function (index) {
                        if(index > -1 && index < config.spots.length){
                            fn.requestWithPayload("api/go_to", JSON.stringify({
                                x: config.spots[index][1],
                                y: config.spots[index][2]
                                }), "PUT", function (err) {
                                    if (err) {
                                        ons.notification.toast(err, { buttonLabel: 'Dismiss', timeout: 1500 })
                                    }
                                    window.setTimeout(function () {
                                        updateHomePage();
                                    }, 3000);
                            });
                        } else {
                            window.setTimeout(function () {
                                        updateHomePage();
                                    }, 3000);
                        }
                    });
                }

                function handleAreaButton() {
                    window.clearTimeout(currentRefreshTimer);
                    var options = []

                    for(var i=0; i < config.areas.length; i++){
                        options.push(config.areas[i][0]);
                    }

                    options.push({
                                label: 'Cancel',
                                icon: 'md-close'
                            });

                    ons.openActionSheet({
                        title: 'Clean area',
                        cancelable: true,
                        buttons: options
                    }).then(function (index) {
                        if(index > -1 && index < config.areas.length){
                            fn.requestWithPayload("api/start_cleaning_zone", JSON.stringify(
                                config.areas[index][1]
                                ), "PUT", function (err) {
                                    if (err) {
                                        ons.notification.toast(err, { buttonLabel: 'Dismiss', timeout: 1500 })
                                    }
                                    window.setTimeout(function () {
                                        updateHomePage();
                                    }, 3000);
                            });
                        } else {
                            window.setTimeout(function () {
                                        updateHomePage();
                                    }, 3000);
                        }
                    });
                }

                function updateHomePage() {
                    loadingBarHome.setAttribute("indeterminate", "indeterminate");
                    fn.request("api/current_status", "GET", function (err, res) {
                        loadingBarHome.removeAttribute("indeterminate");
                        fanspeedButton.removeAttribute("disabled");
                        findRobotButton.removeAttribute("disabled");
                        spotButton.removeAttribute("disabled");

                        if (err) {
                            ons.notification.toast(err, { buttonLabel: 'Dismiss', timeout: 1500 })
                        } else {
                            batteryStatusText.innerHTML = "Battery: " + res.battery + "%";
                            batteryStatusBar.value = res.battery;

                            if (res.state === 12) {
                                robotState.innerHTML = '<span class="robot-error"><ons-icon icon="fa-exclamation-triangle"></ons-icon> ' +
                                    res.human_error +
                                    ' <ons-icon icon="fa-exclamation-triangle"></ons-icon></span>';
                            } else {
                                robotState.innerHTML = res.human_state;
                            }

                            if (res.in_cleaning === 1 || res.in_cleaning === 2) {
                                if (res.state === 3 || res.state === 10 || res.state === 2) {
                                    pauseButton.setAttribute("disabled", "disabled");
                                    startButton.removeAttribute("disabled");
                                } else {
                                    pauseButton.removeAttribute("disabled");
                                    startButton.setAttribute("disabled", "disabled");
                                }
                                spotButton.setAttribute("disabled", "disabled");
                            } else {
                                spotButton.removeAttribute("disabled");
                                pauseButton.setAttribute("disabled", "disabled");
                                if (res.state !== 6) {
                                    startButton.removeAttribute("disabled");
                                } else {
                                    pauseButton.removeAttribute("disabled");
                                    startButton.setAttribute("disabled", "disabled");
                                }
                            }

                            if (res.state === 8 || res.state === 15 || res.state === 10 || res.state === 3 || res.state === 6) {
                                stopButton.setAttribute("disabled", "disabled");
                            } else {
                                stopButton.removeAttribute("disabled");
                            }

                            if (res.state === 5 || res.state === 6 || res.state === 8 || res.state === 9) {
                                homeButton.setAttribute("disabled", "disabled");
                            } else {
                                homeButton.removeAttribute("disabled");
                            }


                            robotStateDetailsM2.innerHTML = "Area: " + ("00" + (res.clean_area / 1000000).toFixed(2)).slice(-6) + " m²";
                            robotStateDetailsTime.innerHTML = "Time: " + window.fn.secondsToHms(res.clean_time);
                            fanspeedButton.innerHTML = "<ons-icon icon=\"fa-superpowers\"></ons-icon> " + fanspeeds[res.fan_power];

                            currentRefreshTimer = window.setTimeout(function () {
                                updateHomePage();
                            }.bind(this), 5000);
                        }
                    })
                }

                ons.getScriptPage().onShow = function () {
                    /* check for area and go to configuration */
                    fn.request("api/get_config", "GET", function (err, res) {
                        config = res;
                        if(config.spots)
                            if(config.spots.length > 0)
                                goToButton.removeAttribute("disabled");
                        if(config.areas)
                            if(config.areas.length > 0)
                                areaButton.removeAttribute("disabled");
                    });
                    updateHomePage();
                };

                ons.getScriptPage().onHide = function () {
                    window.clearTimeout(currentRefreshTimer);
                }

            </script>
            <style>
                #robot-state {
                    text-align: center;
                    font-size: 1.2em;
                    font-weight: 500;
                }

                .robot-error {
                    color: #eb5959;
                }

                #robot-control-buttons {
                    text-align: center;
                }

                    #robot-control-buttons > ons-button {
                        margin: 5px;
                        font-size: 1.2em;
                    }

                #robot-state-details-m2 {
                    margin-right: 5%;
                }

                #robot-state-details-time {
                    text-align: right;
                }
            </style>

        </ons-page>
    </template>


    <template id="zones.html">
        <ons-page id="zones-page">
            <ons-progress-bar id="loading-bar-zones" value="0"></ons-progress-bar>


            <ons-list-title style="margin-top:20px;">Clean zones</ons-list-title>
            <ons-list id="zones-list">
                <ons-list-item>No zones are configured yet.</ons-list-item>
            </ons-list>

            <ons-card onclick="fn.pushPage({'id': 'zones-configuration-go-to.html', 'title': 'Go to configuration'})">
                <div class="title"><ons-icon icon="fa-wrench"></ons-icon> Go to configuration</div>
                <div class="content">Configure go to spots / Check coordinate system</div>
            </ons-card>

            <ons-card onclick="fn.pushPage({'id': 'zones-configuration-zone.html', 'title': 'Zone configuration'})">
                    <div class="title"><ons-icon icon="fa-wrench"></ons-icon> Zone configuration</div>
                    <div class="content">Configure the different zones</div>
                </ons-card>

            <script>
                var loadingBarZones = document.getElementById('loading-bar-zones');
                var zonesList = document.getElementById('zones-list');
                var config;

                function handleZonesCleanButton() {
                    loadingBarZones.setAttribute("indeterminate", "indeterminate");
                    var zones = [];
                    if(config.areas) {
                        /* concatenate all areas of all selected zones */
                        if(config.areas.length > 0) {
                            for(var i=0; i<config.areas.length; i++){
                                if (document.getElementById("zones-index-" + i).checked ) {
                                    for( var j = 0; j < config.areas[i][1].length; j++) {
                                        zones.push(config.areas[i][1][j]);
                                    }
                                }
                            }
                        }

                        fn.requestWithPayload("api/start_cleaning_zone", JSON.stringify(zones), "PUT", function (err) {
                            if (err) {
                                ons.notification.toast(err, { buttonLabel: 'Dismiss', timeout: 1500 })
                                }
                            loadingBarZones.removeAttribute("indeterminate");
                        });
                    }
                }

                ons.getScriptPage().onShow = function () {
                    var out = "";
                    /* check for area and go to configuration */
                    fn.request("api/get_config", "GET", function (err, res) {
                        if(config.areas) {
                            if(config.areas.length > 0) {
                                out = "";
                                for(var i=0; i<config.areas.length; i++){
                                    out += "\
    <ons-list-item tappable> \
      <label class=\"left\"> \
        <ons-checkbox input-id=\"zones-index-" + i + "\"></ons-checkbox> \
      </label> \
      <label for=\"zones-index-" + i + "\" class=\"center\"> \
        " + config.areas[i][0] + " \
      </label> \
    </ons-list-item>";

                                }
                                out += " \
    <ons-list-item> \
        <div class=\"center\"> \
            <ons-button modifier=\"large\" class=\"button-margin\" onclick=\"handleZonesCleanButton();\">Clean zone</ons-button> \
        </div> \
    </ons-list-item>";
                            zonesList.innerHTML = out;
                            }
                        }

                    });
                };
            </script>
            <style>

            </style>
        </ons-page>
    </template>


    <template id="zones-configuration-zone.html">
        <ons-page id="zones-configuration-zone-page">

            <div class="left">
                <ons-back-button>Zones</ons-back-button>
            </div>

            <ons-progress-bar id="loading-bar-zones-config-zone" value="0"></ons-progress-bar>

            <ons-list-title style="margin-top:20px;">Cleanup area definition</ons-list-title>
            <ons-list>
                <ons-list-item>
                    <div class="left">
                        x1:
                    </div>
                    <label class="right" style="width:75%">
                        <ons-input id="zones-config-zone-area-x1" float style="width:100%" value="500"></ons-input>
                    </label>
                </ons-list-item>
                <ons-list-item>
                    <div class="left">
                        y1:
                    </div>
                    <label class="right" style="width:75%">
                        <ons-input id="zones-config-zone-area-y1" float style="width:100%" value="500"></ons-input>
                    </label>
                </ons-list-item>
                <ons-list-item>
                    <div class="left">
                        x2:
                    </div>
                    <label class="right" style="width:75%">
                        <ons-input id="zones-config-zone-area-x2" float style="width:100%" value="1000"></ons-input>
                    </label>
                </ons-list-item>
                <ons-list-item>
                    <div class="left">
                        y2:
                    </div>
                    <label class="right" style="width:75%">
                        <ons-input id="zones-config-zone-area-y2" float style="width:100%" value="1000"></ons-input>
                    </label>
                </ons-list-item>
                <ons-list-item>
                    <div class="left">
                        Iterations:
                    </div>
                    <label class="right" style="width:75%">
                        <ons-input id="zones-config-zone-area-iterations" float style="width:100%" value="2"></ons-input>
                    </label>
                </ons-list-item>
                <ons-list-item>
                    <div class="center">
                        <ons-button id="zones-config-zone-areabutton" modifier="large" class="button-margin" onclick="handlezonesConfigZoneAreaButton();">Clean zone</ons-button>
                    </div>
                </ons-list-item>
            </ons-list>

            <ons-list-title style="margin-top:20px;">Save area as new Zone</ons-list-title>
            <ons-list>
                <ons-list-item>
                    <div class="left">
                        Save as:
                    </div>
                    <label class="right" style="width:75%">
                        <ons-input id="zones-config-zone-name" float style="width:100%" value="My zone"></ons-input>
                    </label>
                </ons-list-item>
                <ons-list-item>
                    <div class="center">
                        <ons-button modifier="large" class="button-margin" onclick="handleZonesConfigZoneSaveButton();">Save new zone</ons-button>
                    </div>
                </ons-list-item>
            </ons-list>

            <ons-list-title style="margin-top:20px;">Add area to existing Zone</ons-list-title>
            <ons-list>
                <ons-list-item>
                    <div class="center">
                        <ons-button modifier="large" class="button-margin" onclick="handleZonesConfigZoneAddButton();">Select a zone to add</ons-button>
                    </div>
                </ons-list-item>
            </ons-list>

            <ons-list-title style="margin-top:20px;">Delete Zone</ons-list-title>
            <ons-list>
                <ons-list-item>
                    <div class="center">
                        <ons-button modifier="large" class="button-margin" onclick="handleZonesConfigZoneDeleteButton();">Select a zone to delete</ons-button>
                    </div>
                </ons-list-item>
            </ons-list>

            <script>
                var loadingBarZonesConfigZone = document.getElementById('loading-bar-zones-config-zone');

                var zonesConfigZoneAreaX1 = document.getElementById('zones-config-zone-area-x1');
                var zonesConfigZoneAreaY1 = document.getElementById('zones-config-zone-area-y1');
                var zonesConfigZoneAreaX2 = document.getElementById('zones-config-zone-area-x2');
                var zonesConfigZoneAreaY2 = document.getElementById('zones-config-zone-area-y2');
                var zonesConfigZoneAreaIterations = document.getElementById('zones-config-zone-area-iterations');

                var zonesConfigZoneName = document.getElementById('zones-config-zone-name');

                function handlezonesConfigZoneAreaButton() {
                    loadingBarZonesConfigZone.setAttribute("indeterminate", "indeterminate");

                    fn.requestWithPayload("api/start_cleaning_zone", JSON.stringify({
                         data: [[parseInt(zonesConfigZoneAreaX1.value), parseInt(zonesConfigZoneAreaY1.value), parseInt(zonesConfigZoneAreaX2.value), parseInt(zonesConfigZoneAreaY2.value), parseInt(zonesConfigZoneAreaIterations.value)]]
                         }), "PUT", function (err) {
                         if (err) {
                               ons.notification.toast(err, { buttonLabel: 'Dismiss', timeout: 1500 })
                            }
                            loadingBarZonesConfigZone.removeAttribute("indeterminate");
                    });
                }

                function handleZonesConfigZoneSaveButton() {
                    loadingBarZonesConfigZone.setAttribute("indeterminate", "indeterminate");
                    config.areas.push([zonesConfigZoneName.value, [[parseInt(zonesConfigZoneAreaX1.value), parseInt(zonesConfigZoneAreaY1.value), parseInt(zonesConfigZoneAreaX2.value), parseInt(zonesConfigZoneAreaY2.value), parseInt(zonesConfigZoneAreaIterations.value)]]]);

                    fn.requestWithPayload("api/set_config", JSON.stringify({config}), "PUT", function (err) {
                        if (err) {
                            ons.notification.toast(err, { buttonLabel: 'Dismiss', timeout: 1500 })
                        }
                        loadingBarZonesConfigZone.removeAttribute("indeterminate");
                    });
                }


                function handleZonesConfigZoneAddButton() {
                    var options = []
                    for(var i=0; i < config.areas.length; i++)
                        options.push(config.areas[i][0]);
                    options.push({ label: 'Cancel', icon: 'md-close' });

                    ons.openActionSheet({
                        title: 'Add area to Zone',
                        cancelable: true,
                        buttons: options
                    }).then(function (index) {
                        if(index > -1 && index < config.areas.length){
                            loadingBarZonesConfigZone.setAttribute("indeterminate", "indeterminate");
                            config.areas[index][1].push([parseInt(zonesConfigZoneAreaX1.value), parseInt(zonesConfigZoneAreaY1.value), parseInt(zonesConfigZoneAreaX2.value), parseInt(zonesConfigZoneAreaY2.value), parseInt(zonesConfigZoneAreaIterations.value)]);

                            fn.requestWithPayload("api/set_config", JSON.stringify({config}), "PUT", function (err) {
                                if (err) {
                                    ons.notification.toast(err, { buttonLabel: 'Dismiss', timeout: 1500 })
                                }
                                loadingBarZonesConfigZone.removeAttribute("indeterminate");
                            });
                        }
                    });
                }

                function handleZonesConfigZoneDeleteButton() {
                    var options = []
                    for(var i=0; i < config.areas.length; i++)
                        options.push(config.areas[i][0]);
                    options.push({ label: 'Cancel', icon: 'md-close' });

                    ons.openActionSheet({
                        title: 'Delete Zone',
                        cancelable: true,
                        buttons: options
                    }).then(function (index) {
                        if(index > -1 && index < config.areas.length){
                            loadingBarZonesConfigZone.setAttribute("indeterminate", "indeterminate");
                            config.areas.splice(index,1);

                            fn.requestWithPayload("api/set_config", JSON.stringify({config}), "PUT", function (err) {
                                if (err) {
                                    ons.notification.toast(err, { buttonLabel: 'Dismiss', timeout: 1500 })
                                }
                                loadingBarZonesConfigZone.removeAttribute("indeterminate");
                            });
                        }
                    });
                }

            </script>
            <style>

            </style>
        </ons-page>
    </template>


    <template id="zones-configuration-go-to.html">
            <ons-page id="zones-configuration-go-to-page">

                <div class="left">
                    <ons-back-button>Zones</ons-back-button>
                </div>

                <ons-progress-bar id="loading-bar-zones-go-to" value="0"></ons-progress-bar>

                <ons-list-title style="margin-top:20px;">Go to setup</ons-list-title>
                <ons-list>
                    <ons-list-item>
                        <div class="left">
                            Go to x:
                        </div>
                        <label class="right" style="width:75%">
                            <ons-input id="zones-config-go-to-x" float style="width:100%" value="100"></ons-input>
                        </label>
                    </ons-list-item>
                    <ons-list-item>
                        <div class="left">
                            Go to y:
                        </div>
                        <label class="right" style="width:75%">
                            <ons-input id="zones-config-go-to-y" float style="width:100%" value="100"></ons-input>
                        </label>
                    </ons-list-item>
                    <ons-list-item>
                        <div class="center">
                            <ons-button id="zones-config-go-to-button" modifier="large" class="button-margin" onclick="handleZonesConfigGoToButton();">Go To</ons-button>
                        </div>
                    </ons-list-item>
                </ons-list>

                <ons-list-title style="margin-top:20px;">Save Go To spot as</ons-list-title>
                <ons-list>
                    <ons-list-item>
                        <div class="left">
                            Save as:
                        </div>
                        <label class="right" style="width:75%">
                            <ons-input id="zones-config-go-to-name" float style="width:100%" value="My go to point"></ons-input>
                        </label>
                    </ons-list-item>
                    <ons-list-item>
                        <div class="center">
                            <ons-button id="zones-config-go-to-save-button" modifier="large" class="button-margin" onclick="handleZonesConfigGoToSaveButton();">Save Go To spot</ons-button>
                        </div>
                    </ons-list-item>
                </ons-list>

                <ons-list-title style="margin-top:20px;">Delete Go To spot</ons-list-title>
                <ons-list>
                    <ons-list-item>
                        <div class="center">
                            <ons-button modifier="large" class="button-margin" onclick="handleZonesConfigGoToDeleteButton();">Select Go To spot to delete</ons-button>
                        </div>
                    </ons-list-item>
                </ons-list>

                <script>
                    var loadingBarZonesGoTo = document.getElementById('loading-bar-zones-go-to');
                    var zonesConfigGoToX = document.getElementById('zones-config-go-to-x');
                    var zonesConfigGoToY = document.getElementById('zones-config-go-to-y');
                    var zonesConfigGoToName = document.getElementById('zones-config-go-to-name');

                    function handleZonesConfigGoToButton() {
                        loadingBarZonesGoTo.setAttribute("indeterminate", "indeterminate");

                        fn.requestWithPayload("api/go_to", JSON.stringify({
                             x: parseInt(zonesConfigGoToX.value),
                             y: parseInt(zonesConfigGoToY.value),
                        }), "PUT", function (err) {
                             if (err) {
                                   ons.notification.toast(err, { buttonLabel: 'Dismiss', timeout: 1500 })
                                }
                            loadingBarZonesGoTo.removeAttribute("indeterminate");
                        });
                    }

                    function handleZonesConfigGoToSaveButton() {
                        loadingBarZonesGoTo.setAttribute("indeterminate", "indeterminate");
                        config.spots.push([zonesConfigGoToName.value, parseInt(zonesConfigGoToX.value), parseInt(zonesConfigGoToY.value)])

                        fn.requestWithPayload("api/set_config", JSON.stringify({config}), "PUT", function (err) {
                             if (err) {
                                   ons.notification.toast(err, { buttonLabel: 'Dismiss', timeout: 1500 })
                                }
                            loadingBarZonesGoTo.removeAttribute("indeterminate");
                        });
                    }


                    function handleZonesConfigGoToDeleteButton() {
                        var options = []

                        for(var i=0; i < config.spots.length; i++){
                            options.push(config.spots[i][0]);
                        }

                        options.push({
                                    label: 'Cancel',
                                    icon: 'md-close'
                                });

                        ons.openActionSheet({
                            title: 'Delete Go To spot',
                            cancelable: true,
                            buttons: options
                        }).then(function (index) {
                            if(index > -1 && index < config.spots.length){
                                loadingBarZonesGoTo.setAttribute("indeterminate", "indeterminate");
                                config.spots.splice(index,1);

                                fn.requestWithPayload("api/set_config", JSON.stringify({config}), "PUT", function (err) {
                                    if (err) {
                                        ons.notification.toast(err, { buttonLabel: 'Dismiss', timeout: 1500 })
                                        }
                                    loadingBarZonesGoTo.removeAttribute("indeterminate");
                                });
                            }
                        });
                    }
                </script>
            </ons-page>
        </template>

    <template id="manualcontrol.html">
        <ons-page id="manualcontrol-page">
            <ons-progress-bar id="loading-bar-manualcontrol" value="0" indeterminate="indeterminate"></ons-progress-bar>

            <div class="aspect-ratio" style="text-align: center; position: relative; height: 99%;" id="notouchmovementsarea">
                    <canvas id="manual-control-area"  class="fit-img fit-img-tight" style="background-color: #9ea7b833; height: 90%; width: 90%; position:relative;"></canvas>
                    <div>
                        <ons-button id="start-manual-control-button" class="button-margin" onclick="startManualControl()">Start Manual Control</ons-button>
                        <ons-button id="stop-manual-control-button" class="button-margin" onclick="stopManualControl()" disabled>Stop Manual Control</ons-button>
                    </div>
            </div>

            <script>
                var manualControlSequenceId = 1;
                var manualControlDurationMS = 100;
                var maxVelocity = 0.3;
                var manualControlMinimalVelocity = 0.02;          //below this abs limit robot will not move
                var manualControlMinimalOmega = 0.1;              //below this abs limit (currentAngle) robot will not turn
                var manualControlminimalDistanceForOmega = 10;    //below this abs limit (currentXYDistance) the robot will not turn
                var currentAngle = 0;
                var currentYDistance = 0;
                var currentXYDistance = 0;
                var currentVelocity = 0;
                var currentOmega = 0;
                var manualControlStateRefreshTimerMS = 2000;      //refresh manual control state each x ms
                var manualControlEnabled = false;
                var manualControlStateRefreshTimer;
                var timedManualControlLoop;

                var startManualControlButton = document.getElementById("start-manual-control-button");
                var endManualControlButton = document.getElementById("stop-manual-control-button");
                var manualControlLoadingBar = document.getElementById('loading-bar-manualcontrol');


                //API / Manual Control Handling
                function manualMoveRobot(angle, velocity) {
                    manualControlLoadingBar.setAttribute("indeterminate", "indeterminate");
                    fn.requestWithPayload("api/set_manual_control", JSON.stringify({
                        angle: angle,
                        velocity: velocity,
                        //move for twice the interval we're updating at
                        //to keep on track if one package got lost
                        duration: manualControlDurationMS*2,
                        sequenceId: manualControlSequenceId++
                    }), "PUT", function (err) {
                        if (err) {
                            ons.notification.toast(err, { buttonLabel: 'Dismiss', timeout: 1500 })
                        }
                        manualControlLoadingBar.removeAttribute("indeterminate");
                    })
                }

                function startManualControl() {
                    if (!manualControlEnabled) {
                        manualControlLoadingBar.setAttribute("indeterminate", "indeterminate");
                        fn.request("api/start_manual_control", "PUT", function (err) {
                            if (err) {
                                ons.notification.toast(err, { buttonLabel: 'Dismiss', timeout: 1500 })
                            } else {
                                manualControlEnabled = true;
                                startManualControlButton.setAttribute("disabled", "disabled");
                                endManualControlButton.removeAttribute("disabled");
                                document.getElementById('sidemenu').removeAttribute("swipeable");
                                document.getElementById('appTabbar').removeAttribute("swipeable");
                            }
                            manualControlLoadingBar.removeAttribute("indeterminate");
                        })
                    }
                }

                function stopManualControl() {
                    if (manualControlEnabled) {
                        manualControlLoadingBar.setAttribute("indeterminate", "indeterminate");
                        fn.request("api/stop_manual_control", "PUT", function (err) {
                            if (err) {
                                ons.notification.toast(err, { buttonLabel: 'Dismiss', timeout: 1500 })
                            } else {
                                manualControlEnabled = false;
                                endManualControlButton.setAttribute("disabled", "disabled");
                                startManualControlButton.removeAttribute("disabled");
                                document.getElementById('sidemenu').setAttribute("swipeable", "swipeable");
                                document.getElementById('appTabbar').setAttribute("swipeable", "swipeable");
                                stopManualControlTimer();
                            }
                            manualControlLoadingBar.removeAttribute("indeterminate");
                        });
                    }
                }

                function sendManualControl() {
                    //limit velocity to square (up, bottom, left, right are to be equal!)
                    if (currentYDistance > cY) {
                        currentYDistance = cY;
                    }
                    currentVelocity = (currentYDistance/cY) * maxVelocity;

                    //center deadzone
                    if (Math.abs(currentVelocity) < manualControlMinimalVelocity) {
                        currentVelocity = 0;
                    }

                    if (Math.abs(currentAngle) < manualControlMinimalOmega  || Math.abs(currentXYDistance) < manualControlminimalDistanceForOmega) {
                        currentOmega = 0;
                    } else {
                        currentOmega = currentAngle;
                    }

                    drawValuesToCanvas();
                    manualMoveRobot(currentOmega, currentVelocity);
                }

                function startManualControlTimer() {
                    if (!timedManualControlLoop && manualControlEnabled) {
                        sendManualControl(); //send + start repetitive timer
                        timedManualControlLoop = setInterval(function(){
                            sendManualControl();
                        }, manualControlDurationMS);
                    }
                }

                function stopManualControlTimer() {
                    if (timedManualControlLoop) {
                        clearInterval(timedManualControlLoop);
                        timedManualControlLoop=0;
                    }
                }

                //Canvas orga
                manualControlCanvas = document.getElementById("manual-control-area");
                //apply shown dimensions to canvas - required because of percentual css dimension
                manualControlCanvas.setAttribute("width", manualControlCanvas.clientWidth);
                manualControlCanvas.setAttribute("height", manualControlCanvas.clientHeight);

                var manualControlCanvasContext= manualControlCanvas.getContext("2d");
                var cX = manualControlCanvas.width / 2;
                var cY = manualControlCanvas.height / 2;

                manualControlCanvasContext.moveTo(cX, cY);
                manualControlCanvasContext.fillStyle = "#ff0044";
                manualControlCanvasContext.arc(cX, cY, 5, 0, 360, false);
                manualControlCanvasContext.fill();

                function drawValuesToCanvas () {
                    //delete old values / draw background
                    manualControlCanvasContext.fillStyle="#FFFFFF"; //#9ea7b833
                    manualControlCanvasContext.fillRect(0,0,200,50);
                    //draw values
                    manualControlCanvasContext.font = "12px Helvetica";
                    manualControlCanvasContext.textAlign = 'left';
                    manualControlCanvasContext.fillStyle = '#8A8A8A';
                    manualControlCanvasContext.fillText("Velocity:\t" + currentVelocity.toPrecision(2) + "\tOmega:\t" + currentOmega.toPrecision(2), 30, 30);
                }

                //Mouse Handling
                function getMousePos(canvasDom, mouseEvent) {
                    var rect = canvasDom.getBoundingClientRect();
                    return {
                        x: mouseEvent.clientX - rect.left,
                        y: mouseEvent.clientY - rect.top
                    };
                }

                ["mousedown", "mouseenter", "mouseup", "mouseleave","mouseout"].forEach(function(evt){
                    manualControlCanvas.addEventListener(evt, function() {
                        startManualControlTimer();
                    }, false);
                });

                manualControlCanvas.addEventListener("mousemove", function(e) {
                    event.preventDefault();
                    var m = getMousePos(manualControlCanvas, e);
                    calculateAngleAndDistance(m);
                }, false);

                //Touch Handling
                function getTouchPos(evt) {
                    var rect = manualControlCanvas.getBoundingClientRect();

                    if (evt && evt.touches) {
                        if (evt.touches.length === 1) { // Only deal with one finger
                            var touch = evt.touches[0]; // Get the information for finger #1
                            return {
                                x : touch.pageX - rect.left,  //-touch.target.offsetLeft,
                                y : touch.pageY - rect.top //-touch.target.offsetTop
                            };
                        }
                    } else {
                        return {
                            x : 0,
                            y : 0
                        };
                    }
                }

                function touchStart(e) {
                    e.preventDefault();
                    startManualControlTimer();
                    var m = getTouchPos();
                    calculateAngleAndDistance(m);
                }

                function touchMove(e) {
                    e.preventDefault();
                    var m = getTouchPos(e);
                    calculateAngleAndDistance(m);
                }

                function touchEnd() {
                    stopManualControlTimer();
                }

                manualControlCanvas.addEventListener("touchstart", touchStart, false);
                manualControlCanvas.addEventListener("touchmove", touchMove, false);
                manualControlCanvas.addEventListener("touchcancel", touchEnd, false);
                manualControlCanvas.addEventListener("touchend", touchEnd, false);

                function calculateAngleAndDistance(m) {
                    var tX = Math.abs(cX - m.x);
                    var tY = Math.abs(cY - m.y);

                    currentYDistance = cY - m.y;
                    currentXYDistance = Math.floor(Math.sqrt(tX * tX + tY * tY));

                    if (m.x < cX) {
                        if (m.y < cY) {
                            //upper left
                            currentAngle = - Math.atan((cX - m.x) / (m.y - cY));
                        } else {
                            //lower left
                            if (m.y === cY) {
                                currentAngle = 0;
                            } else {
                                currentAngle = - Math.atan((m.x - cX) / (m.y - cY));
                            }
                        }
                    } else {
                        if (m.y < cY) {
                            //upper right
                            currentAngle = Math.atan((cX - m.x) / (cY - m.y));
                        } else {
                            //lower right
                            if (cY === m.y ) {
                                currentAngle = 0;
                            } else {
                                currentAngle = Math.atan( (m.x - cX) / (cY - m.y));
                            }
                        }
                    }
                }

                //Page Handling (refresh/update/onload/onhide)
                function refreshManualControlMode() {
                    fn.request("api/current_status", "GET", function (err, res) {
                        if (err) {
                            ons.notification.toast(err, { buttonLabel: 'Dismiss', timeout: 1500 })
                        } else {
                            if (res.state === 7) { //7: manual
                                startManualControl();
                            } else {
                                stopManualControl();
                            }
                        }
                        manualControlLoadingBar.removeAttribute("indeterminate");
                    });
                }

                ons.getScriptPage().onShow = function () {
                    manualControlLoadingBar.setAttribute("indeterminate", "indeterminate");
                    refreshManualControlMode();
                    //Since the robot may disable manual control mode by itself, this timer keeps the
                    //state of the robot in track with the UI
                    manualControlStateRefreshTimer = setInterval(function(){
                        refreshManualControlMode();
                    }, manualControlStateRefreshTimerMS);
                };

                ons.getScriptPage().onHide = function () {
                    stopManualControl();
                    clearInterval(manualControlStateRefreshTimer);
                };

            </script>
            <style>
                #notouchmovementsarea {
                    /* Prevent nearby text being highlighted when accidentally dragging mouse outside confines of the canvas */
                    -webkit-touch-callout: none;
                    -webkit-user-select: none;
                    -khtml-user-select: none;
                    -moz-user-select: none;
                    -ms-user-select: none;
                    user-select: none;
                }
            </style>
        </ons-page>
    </template>

    <template id="map.html">
        <ons-page id="map-page">
            <div class="map-page-container">
                <ons-progress-bar id="loading-bar-map" value="0" indeterminate="indeterminate"></ons-progress-bar>

                <canvas id="map-canvas"></canvas>
            </div>

            <div class="map-page-buttons">
                <ons-fab ripple id="add_zone">
                    <ons-icon icon="fa-plus"></ons-icon>
                </ons-fab>
                <ons-fab ripple id="start_zoned_cleanup">
                    <ons-icon icon="fa-play"></ons-icon>
                </ons-fab>
                <ons-fab ripple id="goto">
                    <ons-icon icon="fa-map-marker"></ons-icon>
                </ons-fab>
            </div>

            <script type="module">
                import { VacuumMap } from "./zone/js-modules/vacuum-map.js"
                const loadingBar = document.getElementById('loading-bar-map');
                let map = null;

                function updateMapPage() {
                    loadingBar.setAttribute("indeterminate", "indeterminate");
                    fn.request("api/map/latest", "GET", function (err, mapData) {
                        loadingBar.removeAttribute("indeterminate");
                        if (!err) {
                            if(map === null) {
                                map = new VacuumMap(document.getElementById('map-canvas'));
                                map.initCanvas(mapData);
                                map.initWebSocket();
                            } else {
                                map.updateMap(mapData);
                            }
                        } else {
                            ons.notification.toast(err, { buttonLabel: 'Dismiss', timeout: 1500 })
                        }
                    })
                }

                // Register update function to be accessible outside of es6 module (see <script> below)
                window.fn.updateMapPage = updateMapPage;
                window.fn.cancelUpdateMap = () => {
                    if(map !== null) {
                        map.closeWebSocket();
                    }
                };

                /**
                 * Calls the goto api route with the currently set goto coordinates
                 */
                function goto_point(point) {
                    fetch("../api/go_to", {
                        method: "put",
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(point)
                    })
                    .then(res => res.text())
                    .then(console.log);
                }

                /**
                 * Calls the zoned_cleanup api route with the currently set zone
                 */
                function zoned_cleanup(zones) {
                    fetch("../api/start_cleaning_zone", {
                        method: "put",
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(zones)
                    })
                    .then(res => res.text())
                    .then(console.log);
                }

                document.getElementById("goto").onclick = () => {
                    const gotoPoint = map.getLocations().gotoPoints[0];
                    if(gotoPoint) goto_point(gotoPoint);
                }
                document.getElementById("start_zoned_cleanup").onclick = () => {
                    const repeatNumber = 1;
                    const zones = map.getLocations().zones.map(zoneCoordinates => [...zoneCoordinates, repeatNumber]);
                    zoned_cleanup(zones);
                }
                document.getElementById("add_zone").onclick = () => map.addZone();
            </script>
            <script defer>
                // Somehow getScriptPage returns null inside the type=module script tag
                ons.getScriptPage().onShow = function () {
                    window.fn.updateMapPage();
                };
                ons.getScriptPage().onHide = function () {
                    window.fn.cancelUpdateMap();

                };
            </script>
            <style>
                :root {
                    --map-background-1: #efeff4;
                    --map-background-2: #afafaf;
                    --map-free: #0076ff;
                    --map-occupied: #52aeff;
                    --path: #ffffff;
                }

                .map-page-container {
                    height: 100%;
                    width: 100%;
                    display: grid;
                    grid-template-columns: 1fr;
                    grid-template-rows: auto 1fr;
                    justify-items: stretch;
                    align-items: stretch;
                }

                canvas#map-canvas {
                    height: 100%;
                    width: 100%;
                    touch-action: none;
                    background-image: linear-gradient(var(--map-background-1), var(--map-background-2));
                }

                .map-page-buttons {
                    position: absolute;
                    right: 1.5em;
                    bottom: 1.5em;
                    display: grid;
                    grid-template-columns: auto;
                    grid-template-rows: auto;
                    grid-gap: 0.5em;
                }

                .map-page-buttons > ons-fab {
                    background-color: #ffffff;
                    color: #31313a;
                }
            </style>
        </ons-page>
    </template>

    <template id="settings.html">
        <ons-page id="settings-page">
            <ons-card onclick="fn.pushPage({'id': 'settings-info.html', 'title': 'Info'})">
                <div class="title"><ons-icon icon="fa-info"></ons-icon> Info</div>
                <div class="content">View device information</div>
            </ons-card>
            <ons-card onclick="fn.pushPage({'id': 'settings-timers.html', 'title': 'Timers'})">
                <div class="title"><ons-icon icon="fa-clock-o"></ons-icon> Timers</div>
                <div class="content">Manage timers</div>
            </ons-card>
            <ons-card onclick="fn.pushPage({'id': 'settings-carpet-mode.html', 'title': 'Carpet Mode'})">
                <div class="title"><ons-icon icon="fa-cart-arrow-down"></ons-icon> Carpet Mode</div>
                <div class="content">Configure carpet mode</div>
            </ons-card>
            <ons-card onclick="fn.pushPage({'id': 'settings-consumables.html', 'title': 'Consumables'})">
                <div class="title"><ons-icon icon="fa-wrench"></ons-icon> Consumables</div>
                <div class="content">View and/or reset consumable usage counters</div>
            </ons-card>
            <ons-card onclick="fn.pushPage({'id': 'settings-cleaning-history.html', 'title': 'Cleaning History'})">
                <div class="title"><ons-icon icon="fa-history"></ons-icon> Cleaning History</div>
                <div class="content">View the cleaning history</div>
            </ons-card>
            <ons-card onclick="fn.pushPage({'id': 'settings-wifi.html', 'title': 'Wifi'})">
                <div class="title"><ons-icon icon="fa-wifi"></ons-icon> Wifi</div>
                <div class="content">View/change wifi details and settings</div>
            </ons-card>
            <ons-card onclick="fn.pushPage({'id': 'settings-token.html', 'title': 'Wifi'})">
                <div class="title"><ons-icon icon="fa-key"></ons-icon> Token</div>
                <div class="content">View the current token</div>
            </ons-card>
            <ons-card onclick="fn.pushPage({'id': 'settings-sound-volume.html', 'title': 'Sound Volume'})">
                <div class="title"><ons-icon icon="fa-volume-up"></ons-icon> Sound Volume</div>
                <div class="content">Change the sound volume</div>
            </ons-card>
            <style>
                .intro {
                    text-align: center;
                    padding: 0 20px;
                    margin-top: 40px;
                }

                ons-card {
                    cursor: pointer;
                    color: #333;
                }

                .card__title,
                .card--material__title {
                    font-size: 20px;
                }
            </style>
        </ons-page>
    </template>

    <template id="settings-info.html">
        <ons-page id="settings-info-page">
            <ons-toolbar>
                <div class="left">
                    <ons-back-button>Settings</ons-back-button>
                </div>
                <div class="center">Info</div>
                <div class="right">
                </div>
            </ons-toolbar>
            <ons-progress-bar id="loading-bar-settings-info" value="0" indeterminate="indeterminate"></ons-progress-bar>

            <ons-list-title style="margin-top:5px;">System</ons-list-title>
            <ons-list>
                <ons-list-item>
                    <div class="left">
                        Firmware version:
                    </div>
                    <div class="right" id="info_fw_version">
                        ???
                    </div>
                </ons-list-item>
                <ons-list-item>
                    <div class="left">
                        Firmware build:
                    </div>
                    <div class="right" id="info_fw_build">
                        ???
                    </div>
                </ons-list-item>
                <ons-list-item>
                    <div class="left">
                        Valetudo version:
                    </div>
                    <div class="right" id="info_valetudo_version">
                        ???
                    </div>
                </ons-list-item>
            </ons-list>
            <ons-list-title style="margin-top:5px;">App Locale</ons-list-title>
            <ons-list>
                <ons-list-item>
                    <div class="left">
                        Name:
                    </div>
                    <div class="right" id="app_locale_name">
                        ???
                    </div>
                </ons-list-item>
                <ons-list-item>
                    <div class="left">
                        Bom:
                    </div>
                    <div class="right" id="app_locale_bom">
                        ???
                    </div>
                </ons-list-item>
                <ons-list-item>
                    <div class="left">
                        Location:
                    </div>
                    <div class="right" id="app_locale_location">
                        ???
                    </div>
                </ons-list-item>
                <ons-list-item>
                    <div class="left">
                        Language:
                    </div>
                    <div class="right" id="app_locale_language">
                        ???
                    </div>
                </ons-list-item>
                <ons-list-item>
                    <div class="left">
                        Timezone:
                    </div>
                    <div class="right" id="app_locale_timezone">
                        ???
                    </div>
                </ons-list-item>
                <ons-list-item>
                    <div class="left">
                        Logserver:
                    </div>
                    <div class="right" id="app_locale_logserver">
                        ???
                    </div>
                </ons-list-item>
            </ons-list>


            <script>
                var loadingBarSettingsInfo = document.getElementById('loading-bar-settings-info');

                ons.getScriptPage().onShow = function() {
                    updateSettingsInfoPage();
                };

                function updateSettingsInfoPage() {
                    loadingBarSettingsInfo.setAttribute("indeterminate", "indeterminate");
                    fn.request("api/get_fw_version", "GET", function (err, res) {
                        loadingBarSettingsInfo.removeAttribute("indeterminate");
                        if (!err) {
                            document.getElementById('info_fw_version').innerHTML = res.version;
                            document.getElementById('info_fw_build').innerHTML = res.build;
                            document.getElementById('info_valetudo_version').innerHTML = res.valetudoVersion;
                        } else {
                            ons.notification.toast(err, { buttonLabel: 'Dismiss', timeout: 1500 })
                        }
                        updateAppLocale();
                    });
                }

                function updateAppLocale() {
                    loadingBarSettingsInfo.setAttribute("indeterminate", "indeterminate");
                    fn.request("api/get_app_locale", "GET", function (err, res) {
                        loadingBarSettingsInfo.removeAttribute("indeterminate");
                        if (!err) {
                            var appLocale = res[0];
                            document.getElementById('app_locale_name').innerHTML = appLocale.name;
                            document.getElementById('app_locale_bom').innerHTML = appLocale.bom;
                            document.getElementById('app_locale_location').innerHTML = appLocale.location;
                            document.getElementById('app_locale_language').innerHTML = appLocale.language;
                            document.getElementById('app_locale_timezone').innerHTML = appLocale.timezone;
                            document.getElementById('app_locale_logserver').innerHTML = appLocale.logserver;
                        } else {
                            ons.notification.toast(err, { buttonLabel: 'Dismiss', timeout: 1500 })
                        }
                    });
                }
            </script>
        </ons-page>
    </template>

    <template id="settings-carpet-mode.html">
        <ons-page id="settings-carpet-mode-page">
            <ons-toolbar>
                <div class="left">
                    <ons-back-button>Settings</ons-back-button>
                </div>
                <div class="center">Carpet Mode</div>
                <div class="right">
                </div>
            </ons-toolbar>
            <ons-progress-bar id="loading-bar-settings-carpet-mode" value="0" indeterminate="indeterminate"></ons-progress-bar>
            <ons-list-title style="margin-top:5px;">Carpet Mode Configuration</ons-list-title>
            <ons-row>
                <ons-col></ons-col>
                <ons-col vertical-align='center' style='text-align:center; max-width: 400px;'>In Carpet Mode, the vacuum will recognize carpets automatically and increase the suction.</ons-col>
                <ons-col></ons-col>
            </ons-row>
            <form id="carpet-mode-form">
                <ons-row>
                    <ons-col></ons-col>
                    <ons-col width="150px" vertical-align='center'>Enabled</ons-col>
                    <ons-col width="150px" vertical-align='center'><ons-checkbox input-id="carpet_mode_enabled"></ons-checkbox></ons-col>
                    <ons-col></ons-col>
                </ons-row>
                <ons-row>
                    <ons-col><br/></ons-col>
                </ons-row>
                <ons-row>
                    <ons-col></ons-col>
                    <ons-col vertical-align='center' style='text-align:center; max-width: 400px;'><b>Only change any of the following parameter if you know what you are doing!</b></ons-col>
                    <ons-col></ons-col>
                </ons-row>
                <ons-row>
                    <ons-col></ons-col>
                    <ons-col width="150px" vertical-align='center'>Current Low</ons-col>
                    <ons-col width="150px" vertical-align='center'><ons-input type="number" placeholder="400" min="1" max="1000" name="current_low"></ons-input></ons-col>
                    <ons-col></ons-col>
                </ons-row>
                <ons-row>
                    <ons-col></ons-col>
                    <ons-col width="150px" vertical-align='center'>Current High</ons-col>
                    <ons-col width="150px" vertical-align='center'><ons-input type="number" placeholder="500" min="1" max="1000" name="current_high"></ons-input></ons-col>
                    <ons-col></ons-col>
                </ons-row>
                <ons-row>
                    <ons-col></ons-col>
                    <ons-col width="150px" vertical-align='center'>Current Integral</ons-col>
                    <ons-col width="150px" vertical-align='center'><ons-input type="number" placeholder="450" min="1" max="1000" name="current_integral"></ons-input></ons-col>
                    <ons-col></ons-col>
                </ons-row>
                <ons-row>
                    <ons-col></ons-col>
                    <ons-col width="150px" vertical-align='center'>Stall Time</ons-col>
                    <ons-col width="150px" vertical-align='center'><ons-input type="number" placeholder="100" min="1" max="100" name="stall_time"></ons-input></ons-col>
                    <ons-col></ons-col>
                </ons-row>
                <ons-row>
                    <ons-col></ons-col>
                    <ons-col width="100px" vertical-align='center'><ons-button modifier="large" class="button-margin" onclick="saveCarpetMode();">Save</ons-button></ons-col>
                    <ons-col></ons-col>
                </ons-row>
            </form>
            <script>
                var loadingBarSettingsCarpetMode = document.getElementById('loading-bar-settings-carpet-mode');

                ons.getScriptPage().onShow = function () {
                    updateSettingsCarpetModePage();
                };

                function updateSettingsCarpetModePage() {
                    loadingBarSettingsCarpetMode.setAttribute("indeterminate", "indeterminate");
                    fn.request("api/get_carpet_mode", "GET", function (err, res) {
                        loadingBarSettingsCarpetMode.removeAttribute("indeterminate");
                        if (err) {
                            ons.notification.toast(err, { buttonLabel: 'Dismiss', timeout: 1500 })
                        } else {
                            var carpetForm = document.getElementById('carpet-mode-form');
                            var result = res[0];
                            carpetForm.current_low.value = result.current_low;
                            carpetForm.current_high.value = result.current_high;
                            carpetForm.current_integral.value = result.current_integral;
                            carpetForm.stall_time.value = result.stall_time;
                            document.getElementById('carpet_mode_enabled').checked = (result.enable==1);
                        }
                    })
                }

                function saveCarpetMode() {
                    ons.notification.confirm('Do you really want to save the modifications made in the carpet mode?').then(function (answer) {
                        if (answer === 1) {
                            loadingBarSettingsCarpetMode.setAttribute("indeterminate", "indeterminate");
                            var carpetForm = document.getElementById('carpet-mode-form');
                            var current_low = carpetForm.current_low.value;
                            var current_high = carpetForm.current_high.value;
                            var current_integral = carpetForm.current_integral.value;
                            var stall_time = carpetForm.stall_time.value;
                            var enable = (document.getElementById('carpet_mode_enabled').checked == true);
                            fn.requestWithPayload("api/set_carpet_mode", JSON.stringify({ enable, current_low, current_high, current_integral, stall_time }), "PUT", function (err, res) {
                                if (err) {
                                    loadingBarSettingsCarpetMode.removeAttribute("indeterminate");
                                    ons.notification.toast(err, { buttonLabel: 'Dismiss', timeout: 1500 })
                                } else {
                                    updateSettingsCarpetModePage();
                                }
                            })
                        }
                    });
                }
            </script>
        </ons-page>
    </template>

    <template id="settings-consumables.html">
        <ons-page id="settings-consumables-page">
            <ons-toolbar>
                <div class="left">
                    <ons-back-button>Settings</ons-back-button>
                </div>
                <div class="center">Consumables</div>
                <div class="right">
                </div>
            </ons-toolbar>
            <ons-progress-bar id="loading-bar-settings-consumables" value="0" indeterminate="indeterminate"></ons-progress-bar>

            <ons-list-title style="margin-top:5px;">Consumables</ons-list-title>
            <ons-list>
                <ons-list-item>
                    <div class="left">
                        Main Brush
                    </div>
                    <div class="center" id="settings-consumables-status-main-brush" style="margin-left:5%">
                        ??? hours left
                    </div>
                    <div class="right">
                        <ons-icon icon="fa-undo" class="list-item__icon" style="color: #eb5959;" onclick="handleConsumableResetButton('main_brush_work_time');"></ons-icon>
                    </div>
                </ons-list-item>
                <ons-list-item>
                    <div class="left">
                        Side Brush
                    </div>
                    <div class="center" id="settings-consumables-status-side-brush" style="margin-left:5%">
                        ??? hours left
                    </div>
                    <div class="right">
                        <ons-icon icon="fa-undo" class="list-item__icon" style="color: #eb5959;" onclick="handleConsumableResetButton('side_brush_work_time');"></ons-icon>
                    </div>
                </ons-list-item>
                <ons-list-item>
                    <div class="left">
                        Filter
                    </div>
                    <div class="center" id="settings-consumables-status-filter" style="margin-left:5%">
                        ??? hours left
                    </div>
                    <div class="right">
                        <ons-icon icon="fa-undo" class="list-item__icon" style="color: #eb5959;" onclick="handleConsumableResetButton('filter_work_time');"></ons-icon>
                    </div>
                </ons-list-item>
                <ons-list-item>
                    <div class="left">
                        Sensor
                    </div>
                    <div class="center" id="settings-consumables-status-sensor" style="margin-left:5%">
                        ??? hours left
                    </div>
                    <div class="right">
                        <ons-icon icon="fa-undo" class="list-item__icon" style="color: #eb5959;" onclick="handleConsumableResetButton('sensor_dirty_time');"></ons-icon>
                    </div>
                </ons-list-item>
            </ons-list>

            <ons-list-title style="margin-top:20px;">All-time statistics</ons-list-title>
            <ons-list>
                <ons-list-item>
                    <div class="left">
                        Total cleaned area:
                    </div>
                    <div class="right" id="settings-consumables-status-statistics-area">
                        ??? m²
                    </div>
                </ons-list-item>
                <ons-list-item>
                    <div class="left">
                        Total cleaning hours:
                    </div>
                    <div class="right" id="settings-consumables-status-statistics-hours">
                        ??? hours
                    </div>
                </ons-list-item>
                <ons-list-item>
                    <div class="left">
                        Total cleaning count:
                    </div>
                    <div class="right" id="settings-consumables-status-statistics-count">
                        ???
                    </div>
                </ons-list-item>
            </ons-list>

            <script>
                var loadingBarSettingsConsumables = document.getElementById('loading-bar-settings-consumables');
                var consumableMainBrushStatus = document.getElementById('settings-consumables-status-main-brush');
                var consumableSideBrushStatus = document.getElementById('settings-consumables-status-side-brush');
                var consumableFilterStatus = document.getElementById('settings-consumables-status-filter');
                var consumableSensorStatus = document.getElementById('settings-consumables-status-sensor');
                var consumableStatisticsArea = document.getElementById('settings-consumables-status-statistics-area');
                var consumableStatisticsHours = document.getElementById('settings-consumables-status-statistics-hours');
                var consumableStatisticsCount = document.getElementById('settings-consumables-status-statistics-count');

                ons.getScriptPage().onShow = function () {
                    updateSettingsConsumablesPage();
                };

                function handleConsumableResetButton(consumable) {
                    ons.notification.confirm('Do you really want to reset this consumable?').then(function (answer) {
                        if (answer === 1) {
                            loadingBarSettingsConsumables.setAttribute("indeterminate", "indeterminate");

                            fn.requestWithPayload("api/reset_consumable", JSON.stringify({ consumable: consumable }), "PUT", function (err, res) {
                                if (err) {
                                    loadingBarSettingsConsumables.removeAttribute("indeterminate");
                                    ons.notification.toast(err, { buttonLabel: 'Dismiss', timeout: 1500 })
                                } else {
                                    updateSettingsConsumablesPage();
                                }
                            })
                        }
                    });
                }

                function updateSettingsConsumablesPage() {
                    loadingBarSettingsConsumables.setAttribute("indeterminate", "indeterminate");
                    fn.request("api/consumable_status", "GET", function (err, res) {
                        loadingBarSettingsConsumables.removeAttribute("indeterminate");
                        if (!err) {
                            consumableMainBrushStatus.innerHTML = (Math.max(0, 300 - (res.consumables.main_brush_work_time / 60 / 60))).toFixed(1) + " hours left";
                            consumableSideBrushStatus.innerHTML = (Math.max(0, 200 - (res.consumables.side_brush_work_time / 60 / 60))).toFixed(1) + " hours left";
                            consumableFilterStatus.innerHTML = (Math.max(0, 150 - (res.consumables.filter_work_time / 60 / 60))).toFixed(1) + " hours left";
                            consumableSensorStatus.innerHTML = (Math.max(0, 30 - (res.consumables.sensor_dirty_time / 60 / 60))).toFixed(1) + " hours left";

                            consumableStatisticsArea.innerHTML = (res.summary[1] / 1000000).toFixed(1) + " m²";
                            consumableStatisticsHours.innerHTML = (res.summary[0] / 60 / 60).toFixed(1) + " hours";
                            consumableStatisticsCount.innerHTML = res.summary[2];
                        } else {
                            ons.notification.toast(err, { buttonLabel: 'Dismiss', timeout: 1500 })
                        }
                    });
                }
            </script>
        </ons-page>
    </template>

    <template id="settings-cleaning-history.html">
        <ons-page id="settings-cleaning-history-page">
            <ons-toolbar>
                <div class="left">
                    <ons-back-button>Settings</ons-back-button>
                </div>
                <div class="center">Cleaning History</div>
                <div class="right">
                </div>
            </ons-toolbar>
            <ons-progress-bar id="loading-bar-settings-cleaning-history" value="0"></ons-progress-bar>

            <ons-list-title style="margin-top:5px;">Last cleaning runs</ons-list-title>
            <ons-list id="settings-cleaning-history">
            </ons-list>
            <div class="center" id="settings-cleaning-history-load-more" style="display:none;padding:10px;text-align:center;"><ons-button modifier="small--quiet" onclick="loadMoreItems();">load more..</ons-button></div>

            <script>
                var loadingBarSettingsCleaningHistory = document.getElementById('loading-bar-settings-cleaning-history');
                var settingsCleaningHistory = document.getElementById('settings-cleaning-history');
                var settingsCleaningHistoryLoadMoreButtons = document.getElementById('settings-cleaning-history-load-more');

                var shownCleaningCount = 0;
                var remainingShownCount = 5;
                var historyArray;

                ons.getScriptPage().onShow = function () {
                    updateSettingsCleaningHistoryPage();
                };

                function loadMoreItems() {
                    remainingShownCount = 5;
                    loadNextRemainingElements();
                }

                function updateSettingsCleaningHistoryPage() {
                    loadingBarSettingsCleaningHistory.setAttribute("indeterminate", "indeterminate");
                    while (settingsCleaningHistory.lastChild) {
                        settingsCleaningHistory.removeChild(settingsCleaningHistory.lastChild);
                    }
                    fn.request("api/clean_summary", "GET", function (err, res) {
                        loadingBarSettingsCleaningHistory.removeAttribute("indeterminate");
                        if (!err) {
                            //summary succeeded
                            historyArray = res[3];
                            loadNextRemainingElements();
                        } else {
                            ons.notification.toast(err, { buttonLabel: 'Dismiss', timeout: 1500 })
                        }
                    });
                }

                function formatTwoDigitNumber(number) {
                    if (number >= 0 && number<=9) {
                        return "0"+number;
                    } else return number;
                }

                function loadNextRemainingElements() {
                    if (remainingShownCount>0) {
                        loadingBarSettingsCleaningHistory.setAttribute("indeterminate", "indeterminate");
                        var historyTimestamp = historyArray.shift(); //array is sorted with latest items in the beginning
                        fn.requestWithPayload("api/clean_record", JSON.stringify({recordId : historyTimestamp}) , "PUT", function (err, res) {
                            loadingBarSettingsCleaningHistory.removeAttribute("indeterminate");
                            if (err) {
                                ons.notification.toast(err, { buttonLabel: 'Dismiss', timeout: 1500 });
                            } else {
                                //adjust counters
                                shownCleaningCount++;
                                remainingShownCount--;
                                //set variables
                                var currentEntryId = historyArray.length+1;
                                var fromTime = new Date(res.startTime).toUTCString();
                                var durationTotalSeconds = res.duration;
                                var durationHours = Math.floor(durationTotalSeconds / 3600);
                                var remsecs = durationTotalSeconds % 3600;
                                var durationMinutes = Math.floor(remsecs / 60);
                                var durationSeconds = (remsecs % 60);
                                var area = Math.round(res.area / 1000000);
                                var errorCode = res.errorCode;
                                var errorDescription = res.errorDescription;
                                var completedFlag = res.finishedFlag;
                                settingsCleaningHistory.appendChild(ons.createElement(
                                    "<ons-list-item>\n" +
                                    "   <ons-row>" +
                                    "       <ons-col></ons-col>" +
                                    "       <ons-col width='400px' vertical-align='center' style='text-align:center;'>#" + currentEntryId + " started on " + fromTime + "</ons-col>" +
                                    "       <ons-col></ons-col>" +
                                    "   </ons-row>" +
                                    "   <ons-row>" +
                                    "       <ons-col></ons-col>" +
                                    "       <ons-col vertical-align='center' width='100px'>Duration</ons-col>" +
                                    "       <ons-col vertical-align='center' width='150px'>" + durationHours + ":" + formatTwoDigitNumber(durationMinutes) + ":" + formatTwoDigitNumber(durationSeconds) + "</ons-col>" +
                                    "       <ons-col></ons-col>" +
                                    "   </ons-row>"+
                                    "   <ons-row>" +
                                    "       <ons-col></ons-col>" +
                                    "       <ons-col vertical-align='center' width='100px'>Area</ons-col>" +
                                    "       <ons-col vertical-align='center' width='150px'>" + area + " m<sup>2</sup></ons-col>" +
                                    "       <ons-col></ons-col>" +
                                    "   </ons-row>"+
                                    "   <ons-row>" +
                                    "       <ons-col></ons-col>" +
                                    "       <ons-col vertical-align='center' width='100px'>Completed</ons-col>" +
                                    "       <ons-col vertical-align='center' width='150px'>" + (completedFlag?"<ons-icon icon='fa-check-circle' style='color:green;'>":"<ons-icon icon='fa-times-circle' style='color:red;'>") + "</ons-col>" +
                                    "       <ons-col></ons-col>" +
                                    "   </ons-row>"+
                                    (errorCode>0?
                                    "   <ons-row>" +
                                    "       <ons-col></ons-col>" +
                                    "       <ons-col vertical-align='center' width='400px' style='text-align:center;'><ons-icon icon='fa-warning' style='color:red;'></ons-icon>&nbsp;" + errorDescription + " (Code: " + errorCode + ")</ons-col>" +
                                    "       <ons-col></ons-col>" +
                                    "   </ons-row>"
                                    : "" ) +
                                    "</ons-list-item>"));
                                //load next element
                                loadNextRemainingElements();
                            }
                        });
                    } else {
                        if (historyArray.length>0) {
                            //show link to load more
                            settingsCleaningHistoryLoadMoreButtons.style.display="block";
                        } else {
                            //hide link to load more
                            settingsCleaningHistoryLoadMoreButtons.style.display="none";
                        }
                    }
                }
            </script>
        </ons-page>
    </template>

    <template id="settings-wifi.html">
        <ons-page id="settings-wifi-page">
            <ons-toolbar>
                <div class="left">
                    <ons-back-button>Settings</ons-back-button>
                </div>
                <div class="center">Wifi</div>
                <div class="right">
                </div>
            </ons-toolbar>
            <ons-progress-bar id="loading-bar-settings-wifi" value="0" indeterminate="indeterminate"></ons-progress-bar>

            <ons-list-title style="margin-top:5px;">Current connection</ons-list-title>
            <ons-list>
                <ons-list-item>
                    <div class="left">
                        Status
                    </div>
                    <div class="right" id="settings-wifi-current-connection-status-connected">
                        ???
                    </div>
                </ons-list-item>
                <ons-list-item>
                    <div class="left">
                        SSID
                    </div>
                    <div class="right" id="settings-wifi-current-connection-status-ssid">
                        ???
                    </div>
                </ons-list-item>
                <ons-list-item>
                    <div class="left">
                        Signal
                    </div>
                    <div class="right" id="settings-wifi-current-connection-status-signal">
                        -?? dBm
                    </div>
                </ons-list-item>
                <ons-list-item>
                    <div class="left">
                        TX Bitrate
                    </div>
                    <div class="right" id="settings-wifi-current-connection-status-tx-bitrate">
                        ??? MBit/s
                    </div>
                </ons-list-item>

            </ons-list>

            <ons-list-title style="margin-top:20px;">Wifi Settings</ons-list-title>
            <ons-list>
                <ons-list-item>
                    <div class="left">
                        SSID:
                    </div>
                    <label class="right" style="width:75%">
                        <ons-input id="settings-wifi-input-ssid" float maxlength="32" placeholder="SSID" style="width:100%"></ons-input>
                    </label>
                </ons-list-item>
                <ons-list-item>
                    <div class="left">
                        Password:
                    </div>
                    <label class="right" style="width:75%">
                        <ons-input id="settings-wifi-input-password" type="password" float maxlength="63" placeholder="Password" style="width:100%;"></ons-input>
                    </label>
                </ons-list-item>
                <ons-list-item>
                    <div class="center">
                        <ons-button id="settings-wifi-input-save-button" modifier="large" class="button-margin" disabled onclick="handleWifiSettingsSaveButton();">Save new Wifi configuration</ons-button>
                    </div>
                </ons-list-item>
            </ons-list>

            <script>
                var loadingBarSettingsWifi = document.getElementById('loading-bar-settings-wifi');
                var wifiCurrentConnectionStatusConnected = document.getElementById('settings-wifi-current-connection-status-connected');
                var wifiCurrentConnectionStatusSSID = document.getElementById('settings-wifi-current-connection-status-ssid');
                var wifiCurrentConnectionStatusSignal = document.getElementById('settings-wifi-current-connection-status-signal');
                var wifiCurrentConnectionStatusTXBitrate = document.getElementById('settings-wifi-current-connection-status-tx-bitrate');

                var wifiInputSSID = document.getElementById('settings-wifi-input-ssid');
                var wifiInputPassword = document.getElementById('settings-wifi-input-password');
                var wifiInputSaveButton = document.getElementById('settings-wifi-input-save-button');

                wifiInputSSID.addEventListener('input', updateWifiCredentialsSaveButton);
                wifiInputPassword.addEventListener('input', updateWifiCredentialsSaveButton);


                ons.getScriptPage().onShow = function() {
                    updateSettingsWifiPage();
                };


                function updateSettingsWifiPage() {
                    loadingBarSettingsWifi.setAttribute("indeterminate", "indeterminate");
                    fn.request("api/wifi_status", "GET", function (err, res) {
                        loadingBarSettingsWifi.removeAttribute("indeterminate");
                        if (!err) {
                            wifiCurrentConnectionStatusConnected.innerHTML = res.connected === true ? "Connected" : "Not connected";
                            if (res.connected) {
                                wifiCurrentConnectionStatusSSID.innerHTML = res.connection_info.ssid;
                                wifiCurrentConnectionStatusSignal.innerHTML = res.connection_info.signal;
                                wifiCurrentConnectionStatusTXBitrate.innerHTML = res.connection_info.tx_bitrate;

                                wifiInputSSID.value = res.connection_info.ssid;
                            }
                        } else {
                            ons.notification.toast(err, { buttonLabel: 'Dismiss', timeout: 1500 })
                        }
                    });
                }

                function updateWifiCredentialsSaveButton() {
                    if (wifiInputSSID.value && wifiInputSSID.value !== "" &&
                        wifiInputPassword.value && wifiInputPassword.value !== "") {

                        wifiInputSaveButton.removeAttribute("disabled");
                    } else {
                        wifiInputSaveButton.setAttribute("disabled", "disabled");
                    }
                }

                function handleWifiSettingsSaveButton() {
                    ons.notification.confirm('Are you sure you want to apply the new wifi settings?<br><br>' +
                        '<span style="font-weight: bold">Hint:</span> You can always revert back to the ' +
                        'integrated Wifi Hotspot by pressing the reset button located underneath the lid.'
                    ).then(function (answer) {
                        if (answer === 1) {
                            loadingBarSettingsWifi.setAttribute("indeterminate", "indeterminate");

                            fn.requestWithPayload("api/wifi_configuration", JSON.stringify({
                                ssid: wifiInputSSID.value,
                                password: wifiInputPassword.value
                            }), "PUT", function (err) {
                                if (err) {
                                    loadingBarSettingsWifi.removeAttribute("indeterminate");
                                    ons.notification.toast(err, { buttonLabel: 'Dismiss', timeout: 1500 })
                                } else {
                                    ons.notification.alert('Successfully applied new wifi credentials.<br>After pressing OK the page will refresh.<br>' +
                                        'However, you will most likely need to change the URL since the robot will connect to a new wifi.').then(function () {
                                            location.reload();
                                        })
                                }
                            })
                        }
                    });
                }
            </script>

            <style>
                #settings-wifi-input-password > input {
                    text-align: right;
                }

                #settings-wifi-input-ssid > input {
                    text-align: right;
                }
            </style>
        </ons-page>
    </template>

    <template id="settings-token.html">
        <ons-page id="settings-token-page">
            <ons-toolbar>
                <div class="left">
                    <ons-back-button>Settings</ons-back-button>
                </div>
                <div class="center">Token</div>
                <div class="right">
                </div>
            </ons-toolbar>
            <ons-progress-bar id="loading-bar-settings-token" value="0" indeterminate="indeterminate"></ons-progress-bar>

            <ons-list-title style="margin-top:5px;">Current Token</ons-list-title>
            <ons-list>
                <ons-list-item>
                    <div class="left">
                        Token
                    </div>
                    <div class="right">
                        <span id="settings-token-label" style="text-align:right;user-select:text;-moz-user-select:text;-ms-user-select:text;-webkit-user-select:text;">
                            ????????????????????????????????
                        </span>
                    </div>
                </ons-list-item>
            </ons-list>
            <script>
                var loadingBarSettingsToken = document.getElementById('loading-bar-settings-token');
                var settingsTokenLabel = document.getElementById('settings-token-label');

                ons.getScriptPage().onShow = function () {
                    updateSettingsTokenPage();
                };

                function updateSettingsTokenPage() {
                    loadingBarSettingsToken.setAttribute("indeterminate", "indeterminate");
                    fn.request("api/token", "GET", function (err, res) {
                        loadingBarSettingsToken.removeAttribute("indeterminate");
                        if (!err) {
                            settingsTokenLabel.innerHTML = res.token;
                        } else {
                            ons.notification.toast(err, { buttonLabel: 'Dismiss', timeout: 1500 })
                        }
                    });
                }
            </script>
        </ons-page>
    </template>

    <template id="settings-sound-volume.html">
        <ons-page id="settings-sound-volume">
            <ons-toolbar>
                <div class="left">
                    <ons-back-button>Settings</ons-back-button>
                </div>
                <div class="center">Sound Volume</div>
                <div class="right">
                </div>
            </ons-toolbar>
            <ons-progress-bar id="loading-bar-settings-sound-volume" value="0" indeterminate="indeterminate"></ons-progress-bar>

            <ons-list-title style="margin-top:20px;">Sound Volume Settings</ons-list-title>
            <ons-list>
                <ons-list-item>
                    <div class="left">
                        Volume:
                    </div>
                    <label class="right" style="width:75%">
                        <ons-row>
                             <ons-col width="40px" style="text-align: center; line-height: 31px;">
                                 <ons-icon icon="md-volume-down"></ons-icon>
                             </ons-col>
                             <ons-col>
                                 <ons-range style="width: 100%;" value="0" id="settings-sound-volume-input-volume"></ons-range>
                             </ons-col>
                             <ons-col width="40px" style="text-align: center; line-height: 31px;">
                                 <ons-icon icon="md-volume-up"></ons-icon>
                             </ons-col>
                         </ons-row>
                    </label>
                </ons-list-item>
                <ons-list-item>
                    <div class="center">
                        <ons-button id="settings-sound-volume-input-save-button" modifier="large" class="button-margin" onclick="handleSoundVolumeSettingsSaveButton();">Save sound volume</ons-button>
                    </div>
                </ons-list-item>
                <ons-list-item>
                    <div class="center">
                        <ons-button id="settings-sound-volume-input-test-button" modifier="large" class="button-margin" onclick="handleSoundVolumeSettingsTestButton();">Test sound volume</ons-button>
                    </div>
                </ons-list-item>
            </ons-list>

            <script>
                var loadingBarSettingsSoundVolume = document.getElementById('loading-bar-settings-sound-volume');
                var soundVolumeInputVolume = document.getElementById('settings-sound-volume-input-volume');

                var soundVolumeInputSaveButton = document.getElementById('settings-sound-volume-input-save-button');

                ons.getScriptPage().onShow = function() {
                    updateSettingsSoundVolumePage();
                };

                function updateSettingsSoundVolumePage() {
                    loadingBarSettingsSoundVolume.setAttribute("indeterminate", "indeterminate");
                    fn.request("api/get_sound_volume", "GET", function (err, res) {
                        loadingBarSettingsSoundVolume.removeAttribute("indeterminate");
                        if (!err) {
                            soundVolumeInputVolume.value = res;
                        } else {
                            ons.notification.toast(err, { buttonLabel: 'Dismiss', timeout: 1500 })
                        }
                    });
                }

                function updateSoundVolumeSaveButton() {
                    if (soundVolumeInputVolume.value && soundVolumeInputVolume.value !== "") {
                        soundVolumeInputSaveButton.removeAttribute("disabled");
                    } else {
                        soundVolumeInputSaveButton.setAttribute("disabled", "disabled");
                    }
                }

                function handleSoundVolumeSettingsSaveButton() {
                    loadingBarSettingsSoundVolume.setAttribute("indeterminate", "indeterminate");

                    fn.requestWithPayload("api/set_sound_volume", JSON.stringify({
                         volume: soundVolumeInputVolume.value
                    }), "PUT", function (err) {
                         if (err) {
                               ons.notification.toast(err, { buttonLabel: 'Dismiss', timeout: 1500 })
                            }
                        loadingBarSettingsSoundVolume.removeAttribute("indeterminate");
                    });
                }

                function handleSoundVolumeSettingsTestButton() {
                    loadingBarSettingsSoundVolume.setAttribute("indeterminate", "indeterminate");

                    fn.request("api/test_sound_volume", "PUT", function (err, res) {
                        loadingBarSettingsSoundVolume.removeAttribute("indeterminate");
                        if (err) {
                            ons.notification.toast(err, { buttonLabel: 'Dismiss', timeout: 1500 })
                        }
                    });
                }
            </script>
        </ons-page>
    </template>

    <template id="settings-timers.html">
        <ons-page id="settings-timers-page">
                <ons-dialog id="add-timer-dialog">
                    <div style="text-align: left; padding: 10px;">
                        <form id="add-timer-form">
                            <!--Date-->
                            <p>Select the date the timer should be triggered on.<br/><i>Empty means any month/day.</i></p>
                            <ons-row>
                                <ons-col width="100px" align="center">Month</ons-col>
                                <ons-col><ons-input type="number" placeholder="*" min="1" max="12" name="month"></ons-input></ons-col>
                            </ons-row>
                            <ons-row>
                                <ons-col width="100px" align="center">Day</ons-col>
                                <ons-col><ons-input type="number" placeholder="*" min="1" max="31" name="day"></ons-input></ons-col>
                            </ons-row>
                            <hr/>
                            <!--Time-->
                            <p>Select the time the timer should be triggered on.<br/><i>Empty means any hour/minute.</i></p>
                            <ons-row>
                                <ons-col width="100px" align="center">Hour</ons-col>
                                <ons-col><ons-input type="number" placeholder="*" min="0" max="23" name="hour"></ons-input></ons-col>
                            </ons-row>
                            <ons-row>
                                <ons-col width="100px" align="center">Minute</ons-col>
                                <ons-col><ons-input type="number" placeholder="*" min="0" max="59" name="minute"></ons-input></ons-col>
                            </ons-row>
                            <hr/>
                            <!--Days-->
                            <p>Select the days the timer should be triggered on.<br/><i>Empty means any day.</i></p>
                            <ons-row>
                                <ons-col width="100px">Days</ons-col>
                                <ons-col style="padding-bottom:10px;">
                                    <ons-checkbox name="days" value="1" input-id="timer_mo"></ons-checkbox>
                                    <label for="timer_mo" class="center">Monday</label>
                                </ons-col>
                            </ons-row>
                            <ons-row>
                                <ons-col width="100px"></ons-col>
                                <ons-col style="padding-bottom:10px;">
                                    <ons-checkbox name="days" value="2" input-id="timer_tue"></ons-checkbox>
                                    <label for="timer_tue" class="center">Tuesday</label>
                                </ons-col>
                            </ons-row>
                            <ons-row>
                                <ons-col width="100px"></ons-col>
                                <ons-col style="padding-bottom:10px;">
                                    <ons-checkbox name="days" value="3" input-id="timer_wed"></ons-checkbox>
                                    <label for="timer_wed" class="center">Wednesday</label>
                                </ons-col>
                            </ons-row>
                            <ons-row>
                                <ons-col width="100px"></ons-col>
                                <ons-col style="padding-bottom:10px;">
                                    <ons-checkbox name="days" value="4" input-id="timer_thu"></ons-checkbox>
                                    <label for="timer_thu" class="center">Thursday</label>
                                </ons-col>
                            </ons-row>
                            <ons-row>
                                <ons-col width="100px"></ons-col>
                                <ons-col style="padding-bottom:10px;">
                                    <ons-checkbox name="days" value="5" input-id="timer_fri"></ons-checkbox>
                                    <label for="timer_fri" class="center">Friday</label>
                                </ons-col>
                            </ons-row>
                            <ons-row>
                                <ons-col width="100px"></ons-col>
                                <ons-col style="padding-bottom:10px;">
                                    <ons-checkbox name="days" value="6" input-id="timer_sat"></ons-checkbox>
                                    <label for="timer_sat" class="center">Saturday</label>
                                </ons-col>
                            </ons-row>
                            <ons-row>
                                <ons-col width="100px"></ons-col>
                                <ons-col style="padding-bottom:10px;">
                                    <ons-checkbox name="days" value="0" input-id="timer_sun"></ons-checkbox>
                                    <label for="timer_sun" class="center">Sunday</label>
                                </ons-col>
                            </ons-row>
                            <div style="text-align: center" class="content-padded" ng-controller="ButtonsController">
                                    <ons-button onclick="hideNewTimerDialog()">Cancel</ons-button>
                                    <ons-button onclick="addNewTimer()">Save</ons-button>
                            </div>
                        </form>
                    </div>
                </ons-dialog>
                <ons-dialog id="edit-dnd-timer-dialog">
                    <div style="text-align: left; padding: 10px;">
                        <form id="edit-dnd-form">
                            <ons-row>
                                <ons-col width="100px" align="center">Start Hour</ons-col>
                                <ons-col><ons-input placeholder="?" type="number" min="0" max="24" name="start_hour" required ></ons-input></ons-col>
                                <ons-col width="100px" align="center">Start Minute</ons-col>
                                <ons-col><ons-input placeholder="?" type="number" min="0" max="59" name="start_minute" required ></ons-input></ons-col>
                            </ons-row>
                            <ons-row>
                                <ons-col width="100px" align="center">End Hour</ons-col>
                                <ons-col><ons-input placeholder="?" type="number" min="0" max="24" name="end_hour" required ></ons-input></ons-col>
                                <ons-col width="100px" align="center">End Minute</ons-col>
                                <ons-col><ons-input placeholder="?" type="number" min="0" max="59" name="end_minute" required ></ons-input></ons-col>
                            </ons-row>
                            <div style="text-align: center" class="content-padded" ng-controller="ButtonsController">
                                    <ons-button onclick="hideDndTimerDialog()">Cancel</ons-button>
                                    <ons-button onclick="saveDndTimer()">Save</ons-button>
                                    <!--<input class="button" type="submit" onclick="saveDndTimer()" value="Save">-->
                            </div>
                        </form>
                    </div>
                </ons-dialog>
                <ons-dialog id="edit-timezone-dialog">
                        <div style="text-align: left; padding: 10px;">
                            <form id="edit-timezone-form">
                                Your current timezone is set to:<br/>
                                <ons-select select-id="timezone-selection"><!-- will be filled dynamically --></ons-select><br/><br/>
                                <div style="text-align: center" class="content-padded" ng-controller="ButtonsController">
                                        <ons-button onclick="hideTimeZoneDialog()">Close</ons-button>
                                        <ons-button onclick="saveTimeZone()">Save</ons-button>
                                        <!--<input class="button" type="submit" onclick="saveDndTimer()" value="Save">-->
                                </div>
                            </form>
                        </div>
                    </ons-dialog>
            <ons-toolbar>
                <div class="left">
                    <ons-back-button>Settings</ons-back-button>
                </div>
                <div class="center">Timers</div>
                <div class="right">
                    <ons-toolbar-button id="settings-timers-timezone" onclick="showTimeZoneDialog();">
                        <ons-icon icon="fa-cog"></ons-icon>
                    </ons-toolbar-button>
                </div>
            </ons-toolbar>
            <ons-progress-bar id="loading-bar-settings-timers" value="0" indeterminate="indeterminate"></ons-progress-bar>

            <ons-list-title style="margin-top:5px;">
                Cleaning - Timers <ons-toolbar-button id="settings-timers-create-new-timer" onclick="showAddTimerDialog(-1);"><ons-icon icon="fa-plus"></ons-icon></ons-toolbar-button></div>
            </ons-list-title>
            <ons-list id="settings-timers-timer-list"></ons-list>

            <ons-list-title style="margin-top:5px;">"Do Not Disturb" - Timer</ons-list-title>
            <ons-list id="settings-dnd-timer-list"></ons-list>

            <script>
                var loadingBarSettingsTimers = document.getElementById('loading-bar-settings-timers');
                var timersSettingsTimersList = document.getElementById('settings-timers-timer-list');
                var dndTimerList = document.getElementById('settings-dnd-timer-list');

                ons.getScriptPage().onShow = function () {
                    updateSettingsTimersPage();
                    updateDndTimerPage();
                };

                function showTimeZoneDialog() {
                    loadingBarSettingsTimers.setAttribute("indeterminate", "indeterminate");
                    fn.request("api/get_timezone", "GET", function (err, currentTimeZone) {
                        loadingBarSettingsTimers.removeAttribute("indeterminate");
                        if (!err) {
                            var timeZoneSelection = document.getElementById('timezone-selection');
                            if (timeZoneSelection.childElementCount  == 0) {
                                //initialize select options only if not already done
                                //TODO: Those timezones should be outsourced to a config file
                                var allTimezones =['Africa/Abidjan', 'Africa/Accra', 'Africa/Algiers', 'Africa/Bissau', 'Africa/Cairo', 'Africa/Casablanca', 'Africa/Ceuta', 'Africa/El_Aaiun','Africa/Johannesburg',
                                'Africa/Juba', 'Africa/Khartoum', 'Africa/Lagos', 'Africa/Maputo', 'Africa/Monrovia', 'Africa/Nairobi', 'Africa/Ndjamena', 'Africa/Sao_Tome', 'Africa/Tripoli', 'Africa/Tunis',
                                'Africa/Windhoek', 'America/Adak', 'America/Anchorage', 'America/Araguaina', 'America/Argentina/Buenos_Aires', 'America/Argentina/Catamarca', 'America/Argentina/Cordoba',
                                'America/Argentina/Jujuy', 'America/Argentina/La_Rioja', 'America/Argentina/Mendoza', 'America/Argentina/Rio_Gallegos', 'America/Argentina/Salta', 'America/Argentina/San_Juan',
                                'America/Argentina/San_Luis', 'America/Argentina/Tucuman', 'America/Argentina/Ushuaia', 'America/Asuncion', 'America/Atikokan', 'America/Bahia', 'America/Bahia_Banderas',
                                'America/Barbados', 'America/Belem', 'America/Belize', 'America/Blanc-Sablon', 'America/Boa_Vista', 'America/Bogota', 'America/Boise', 'America/Cambridge_Bay', 'America/Campo_Grande',
                                'America/Cancun', 'America/Caracas', 'America/Cayenne', 'America/Chicago', 'America/Chihuahua', 'America/Costa_Rica', 'America/Creston', 'America/Cuiaba', 'America/Curacao',
                                'America/Danmarkshavn', 'America/Dawson', 'America/Dawson_Creek', 'America/Denver', 'America/Detroit', 'America/Edmonton', 'America/Eirunepe', 'America/El_Salvador', 'America/Fortaleza',
                                'America/Fort_Nelson', 'America/Glace_Bay', 'America/Godthab', 'America/Goose_Bay', 'America/Grand_Turk', 'America/Guatemala', 'America/Guayaquil', 'America/Guyana', 'America/Halifax',
                                'America/Havana', 'America/Hermosillo', 'America/Indiana/Indianapolis', 'America/Indiana/Knox', 'America/Indiana/Marengo', 'America/Indiana/Petersburg', 'America/Indiana/Tell_City',
                                'America/Indiana/Vevay', 'America/Indiana/Vincennes', 'America/Indiana/Winamac', 'America/Inuvik', 'America/Iqaluit', 'America/Jamaica', 'America/Juneau', 'America/Kentucky/Louisville',
                                'America/Kentucky/Monticello', 'America/La_Paz', 'America/Lima', 'America/Los_Angeles', 'America/Maceio', 'America/Managua', 'America/Manaus', 'America/Martinique', 'America/Matamoros',
                                'America/Mazatlan', 'America/Menominee', 'America/Merida', 'America/Metlakatla', 'America/Mexico_City', 'America/Miquelon', 'America/Moncton', 'America/Monterrey', 'America/Montevideo',
                                'America/Nassau', 'America/New_York', 'America/Nipigon', 'America/Nome', 'America/Noronha', 'America/North_Dakota/Beulah', 'America/North_Dakota/Center', 'America/North_Dakota/New_Salem',
                                'America/Ojinaga', 'America/Panama', 'America/Pangnirtung', 'America/Paramaribo', 'America/Phoenix', 'America/Port-au-Prince', 'America/Porto_Velho', 'America/Port_of_Spain',
                                'America/Puerto_Rico', 'America/Punta_Arenas', 'America/Rainy_River', 'America/Rankin_Inlet', 'America/Recife', 'America/Regina', 'America/Resolute', 'America/Rio_Branco',
                                'America/Santarem', 'America/Santiago', 'America/Santo_Domingo', 'America/Sao_Paulo', 'America/Scoresbysund', 'America/Sitka', 'America/St_Johns', 'America/Swift_Current',
                                'America/Tegucigalpa', 'America/Thule', 'America/Thunder_Bay', 'America/Tijuana', 'America/Toronto', 'America/Vancouver', 'America/Whitehorse', 'America/Winnipeg', 'America/Yakutat',
                                'America/Yellowknife', 'Antarctica/Casey', 'Antarctica/Davis', 'Antarctica/DumontDUrville', 'Antarctica/Macquarie', 'Antarctica/Mawson', 'Antarctica/Palmer', 'Antarctica/Rothera',
                                'Antarctica/Syowa', 'Antarctica/Troll', 'Antarctica/Vostok', 'Asia/Almaty', 'Asia/Amman', 'Asia/Anadyr', 'Asia/Aqtau', 'Asia/Aqtobe', 'Asia/Ashgabat', 'Asia/Atyrau', 'Asia/Baghdad',
                                'Asia/Baku', 'Asia/Bangkok', 'Asia/Barnaul', 'Asia/Beirut', 'Asia/Bishkek', 'Asia/Brunei', 'Asia/Chita', 'Asia/Choibalsan', 'Asia/Colombo', 'Asia/Damascus', 'Asia/Dhaka', 'Asia/Dili',
                                'Asia/Dubai', 'Asia/Dushanbe', 'Asia/Famagusta', 'Asia/Gaza', 'Asia/Hebron', 'Asia/Hong_Kong', 'Asia/Hovd', 'Asia/Ho_Chi_Minh', 'Asia/Irkutsk', 'Asia/Jakarta', 'Asia/Jayapura',
                                'Asia/Jerusalem', 'Asia/Kabul', 'Asia/Kamchatka', 'Asia/Karachi', 'Asia/Kathmandu', 'Asia/Khandyga', 'Asia/Kolkata', 'Asia/Krasnoyarsk', 'Asia/Kuala_Lumpur', 'Asia/Kuching', 'Asia/Macau',
                                'Asia/Magadan', 'Asia/Makassar', 'Asia/Manila', 'Asia/Nicosia', 'Asia/Novokuznetsk', 'Asia/Novosibirsk', 'Asia/Omsk', 'Asia/Oral', 'Asia/Pontianak', 'Asia/Pyongyang', 'Asia/Qatar',
                                'Asia/Qostanay', 'Asia/Qyzylorda', 'Asia/Riyadh', 'Asia/Sakhalin', 'Asia/Samarkand', 'Asia/Seoul', 'Asia/Shanghai', 'Asia/Singapore', 'Asia/Srednekolymsk', 'Asia/Taipei', 'Asia/Tashkent',
                                'Asia/Tbilisi', 'Asia/Tehran', 'Asia/Thimphu', 'Asia/Tokyo', 'Asia/Tomsk', 'Asia/Ulaanbaatar', 'Asia/Urumqi', 'Asia/Ust-Nera', 'Asia/Vladivostok', 'Asia/Yakutsk', 'Asia/Yangon',
                                'Asia/Yekaterinburg', 'Asia/Yerevan', 'Atlantic/Azores', 'Atlantic/Bermuda', 'Atlantic/Canary', 'Atlantic/Cape_Verde', 'Atlantic/Faroe', 'Atlantic/Madeira', 'Atlantic/Reykjavik',
                                'Atlantic/South_Georgia', 'Atlantic/Stanley', 'Australia/Adelaide', 'Australia/Brisbane', 'Australia/Broken_Hill', 'Australia/Currie', 'Australia/Darwin', 'Australia/Eucla',
                                'Australia/Hobart', 'Australia/Lindeman', 'Australia/Lord_Howe', 'Australia/Melbourne', 'Australia/Perth', 'Australia/Sydney', 'Europe/Amsterdam','Europe/Andorra', 'Europe/Astrakhan',
                                'Europe/Athens', 'Europe/Belgrade', 'Europe/Berlin', 'Europe/Brussels', 'Europe/Bucharest', 'Europe/Budapest', 'Europe/Chisinau', 'Europe/Copenhagen', 'Europe/Dublin', 'Europe/Gibraltar',
                                'Europe/Helsinki', 'Europe/Istanbul', 'Europe/Kaliningrad', 'Europe/Kiev', 'Europe/Kirov', 'Europe/Lisbon', 'Europe/London', 'Europe/Luxembourg', 'Europe/Madrid', 'Europe/Malta',
                                'Europe/Minsk', 'Europe/Monaco', 'Europe/Moscow', 'Europe/Oslo', 'Europe/Paris', 'Europe/Prague', 'Europe/Riga', 'Europe/Rome', 'Europe/Samara', 'Europe/Saratov', 'Europe/Simferopol',
                                'Europe/Sofia', 'Europe/Stockholm', 'Europe/Tallinn', 'Europe/Tirane', 'Europe/Ulyanovsk', 'Europe/Uzhgorod', 'Europe/Vienna', 'Europe/Vilnius', 'Europe/Volgograd', 'Europe/Warsaw',
                                'Europe/Zaporozhye', 'Europe/Zurich', 'Indian/Chagos', 'Indian/Christmas', 'Indian/Cocos', 'Indian/Kerguelen', 'Indian/Mahe', 'Indian/Maldives', 'Indian/Mauritius', 'Indian/Reunion',
                                'Pacific/Apia', 'Pacific/Auckland', 'Pacific/Bougainville', 'Pacific/Chatham', 'Pacific/Chuuk', 'Pacific/Easter', 'Pacific/Efate', 'Pacific/Enderbury', 'Pacific/Fakaofo', 'Pacific/Fiji',
                                'Pacific/Funafuti', 'Pacific/Galapagos', 'Pacific/Gambier', 'Pacific/Guadalcanal', 'Pacific/Guam', 'Pacific/Honolulu', 'Pacific/Kiritimati', 'Pacific/Kosrae', 'Pacific/Kwajalein',
                                'Pacific/Majuro', 'Pacific/Marquesas', 'Pacific/Nauru', 'Pacific/Niue', 'Pacific/Norfolk', 'Pacific/Noumea', 'Pacific/Pago_Pago', 'Pacific/Palau', 'Pacific/Pitcairn', 'Pacific/Pohnpei',
                                'Pacific/Port_Moresby', 'Pacific/Rarotonga', 'Pacific/Tahiti', 'Pacific/Tarawa', 'Pacific/Tongatapu', 'Pacific/Wake', 'Pacific/Wallis'];
                                allTimezones.forEach(function (tmpTimeZone) {
                                    var tmpOption = document.createElement("option");
                                    tmpOption.innerText = tmpTimeZone;
                                    tmpOption.value = tmpTimeZone;
                                    if (tmpTimeZone == currentTimeZone) {
                                        tmpOption.selected = true;
                                    }
                                    timeZoneSelection.appendChild(tmpOption);
                                });
                            } else {
                                //adjust selection to match server side setting
                                for (var i = 0; i < timeZoneSelection.options.length; i++) {
                                    tmpOption = timeZoneSelection.options[i];
                                    if (tmpOption.value == currentTimeZone) {
                                        tmpOption.selected = true;
                                    } else {
                                        tmpOption.selected = false;
                                    }
                                }
                            }
                            document.getElementById('edit-timezone-dialog').show();
                        } else {
                            ons.notification.toast(err, { buttonLabel: 'Dismiss', timeout: 1500 });
                        }
                    });
                }

                function hideTimeZoneDialog() {
                    document.getElementById('edit-timezone-dialog').hide();
                }

                function saveTimeZone() {
                    var timeZoneSelection = document.getElementById('timezone-selection');
                    var newTimezone = timeZoneSelection.options[timeZoneSelection.selectedIndex].value;

                    ons.notification.confirm('Do you really want to set your timezone to "' + newTimezone + '"?').then(function (answer) {
                        if (answer === 1) {
                            loadingBarSettingsTimers.setAttribute("indeterminate", "indeterminate");
                            fn.requestWithPayload("/api/set_timezone", JSON.stringify({ new_zone : newTimezone }), "POST", function (err, res) {
                                loadingBarSettingsTimers.removeAttribute("indeterminate");
                                if (err) {
                                    ons.notification.toast(err, { buttonLabel: 'Dismiss', timeout: 1500 });
                                } else {
                                    hideTimeZoneDialog();
                                }
                            });
                        }
                    });
                }

                var showDndTimerDialog = function(startHour, startMinute, endHour, endMinute) {
                    document.getElementById('edit-dnd-form').start_hour.value = (startHour>=0?startHour:"");
                    document.getElementById('edit-dnd-form').start_minute.value = (startMinute>=0?startMinute:"");
                    document.getElementById('edit-dnd-form').end_hour.value = (endHour>=0?endHour:"");
                    document.getElementById('edit-dnd-form').end_minute.value = (endMinute>=0?endMinute:"");
                    document.getElementById('edit-dnd-timer-dialog').show();
                };

                var hideDndTimerDialog = function() {
                    document.getElementById('edit-dnd-timer-dialog').hide();
                };

                //TODO: There should be some util to convert numbers to leading zero numbers
                function asTwoDigitNumber(number) {
                    if (number<10) return "0" + number;
                    else return number;
                }

                function updateDndTimerPage() {
                    loadingBarSettingsTimers.setAttribute("indeterminate", "indeterminate");
                    while (dndTimerList.lastChild) {
                        dndTimerList.removeChild(dndTimerList.lastChild);
                    }
                    fn.request("api/get_dnd", "GET", function (err, res) {
                        loadingBarSettingsTimers.removeAttribute("indeterminate");
                        if (!err) {
                            //TODO: Check if multiple dnd timers can be created!
                            if (res.length == 0 || res[0].enabled  == 0) {
                                //no timer is enabled yet, show possibility to add dnd timer
                                dndTimerList.appendChild(ons.createElement(
                                    "<ons-list-item>\n" +
                                    "    <div class='left'>There is no DND timer enabled yet.</div>" +
                                    "    <div class='right'>" +
                                    "        <ons-button modifier='quiet' class='button-margin' style='font-size: 2em;' onclick='showDndTimerDialog(-1, -1, -1, -1);'>" +
                                    "            <ons-icon icon='fa-edit'></ons-icon>" +
                                    "        </ons-button>" +
                                    "    </div>" +
                                    "</ons-list-item>"
                                ));
                            } else {
                                //Show current active timer
                                res.forEach(function (dndTimer) {
                                    dndTimerList.appendChild(ons.createElement(
                                        "<ons-list-item>\n" +
                                        "    <div class='left'>DND will start at " + dndTimer.start_hour + ":" + asTwoDigitNumber(dndTimer.start_minute) + " and end on " + dndTimer.end_hour + ":" + asTwoDigitNumber(dndTimer.end_minute) + "</div>" +
                                        "    <div class='right'>" +
                                        "        <ons-button modifier='quiet' class='button-margin' style='font-size: 2em;' onclick='showDndTimerDialog(" + dndTimer.start_hour + ", " + dndTimer.start_minute + ", " + dndTimer.end_hour + ", " + dndTimer.end_minute +");'>" +
                                        "            <ons-icon icon='fa-edit'></ons-icon>" +
                                        "        </ons-button>" +
                                        "        <ons-button modifier='quiet' class='button-margin' style='font-size: 2em;' onclick='deleteDndTimer();'>" +
                                        "            <ons-icon icon='fa-trash'></ons-icon>" +
                                        "        </ons-button>" +
                                        "    </div>" +
                                        "</ons-list-item>"
                                    ));
                                });
                            }
                        } else {
                            ons.notification.toast(err, { buttonLabel: 'Dismiss', timeout: 1500 });
                        }
                    });
                }

                function deleteDndTimer() {
                    ons.notification.confirm('Do you really want to disable DND?').then(function (answer) {
                        if (answer === 1) {
                            loadingBarSettingsTimers.setAttribute("indeterminate", "indeterminate");
                            fn.request("api/delete_dnd", "PUT", function (err) {
                                loadingBarSettingsTimers.removeAttribute("indeterminate");
                                if (err) {
                                    ons.notification.toast(err, { buttonLabel: 'Dismiss', timeout: 1500 });
                                } else {
                                    updateDndTimerPage();
                                }
                            });
                        }
                    });
                }

                function saveDndTimer() {
                    var start_hour = document.getElementById('edit-dnd-form').start_hour.value;
                    var start_minute = document.getElementById('edit-dnd-form').start_minute.value;
                    var end_hour = document.getElementById('edit-dnd-form').end_hour.value;
                    var end_minute = document.getElementById('edit-dnd-form').end_minute.value;
                    if (start_hour && start_minute && end_hour && end_minute) {
                        fn.requestWithPayload("/api/set_dnd", JSON.stringify({ start_hour, start_minute, end_hour, end_minute}), "POST", function (err, res) {
                        if (err) {
                            ons.notification.toast(err, { buttonLabel: 'Dismiss', timeout: 1500 });
                        }
                        hideDndTimerDialog();
                        updateDndTimerPage();
                    });
                    } else {
                        ons.notification.toast("Could not save DND Timer since not all required attributes are provided!", { buttonLabel: 'Dismiss', timeout: 1500 });
                    }
                }

                function updateSettingsTimersPage() {
                    loadingBarSettingsTimers.setAttribute("indeterminate", "indeterminate");
                    while (timersSettingsTimersList.lastChild) {
                        timersSettingsTimersList.removeChild(timersSettingsTimersList.lastChild);
                    }

                    fn.request("api/timers", "GET", function (err, res) {
                        loadingBarSettingsTimers.removeAttribute("indeterminate");
                        if (!err) {
                            if (res == null ||  res.length == 0) {
                                timersSettingsTimersList.appendChild(ons.createElement(
                                    "<ons-list-item>\n" +
                                    "    <div class='center'>There is no timer configured yet.</div>" +
                                    "</ons-list-item>"
                                ));
                            }

                            res.forEach(function (timer) {
                                //ADD EDIT (equals create new + delete!)
                                var elem = ons.createElement(
                                    "<ons-list-item data-id='" + timer.id + "'>\n" +
                                    "    <div class='left'>" + timer.human_desc + " (" + timer.cron + ")</div>" +
                                    "    <div class='right'>" +
                                    "        <ons-switch class='timer-active-switch'" + (timer.enabled ? " checked='checked' " : "") + "></ons-switch> " +
                                    "        <ons-button modifier='quiet' class='button-margin timer-delete'>" +
                                    "            <ons-icon icon='fa-trash'></ons-icon>" +
                                    "        </ons-button>" +
                                    "    </div>" +
                                    "</ons-list-item>"
                                );

                                elem.querySelector('.timer-active-switch').addEventListener('change', function (event) {
                                    toggleTimer(timer.id, event.value);
                                });

                                elem.querySelector('.timer-delete').addEventListener('click', function (event) {
                                    deleteTimer(timer.id);
                                });

                                timersSettingsTimersList.appendChild(elem);
                            });
                        } else {
                            ons.notification.toast(err, { buttonLabel: 'Dismiss', timeout: 1500 });
                        }
                    });
                }

                function toggleTimer(id, enabled) {
                    disableTimerInputElements();
                    loadingBarSettingsTimers.setAttribute("indeterminate", "indeterminate");

                    fn.requestWithPayload("api/timers/" + id, JSON.stringify({ enabled: enabled }), "PUT", function (err, res) {
                        if (err) {
                            ons.notification.toast(err, { buttonLabel: 'Dismiss', timeout: 1500 });
                        }
                        window.setTimeout(function () {
                            updateSettingsTimersPage();
                        }, 350);
                    })
                }

                function disableTimerInputElements() {
                    timersSettingsTimersList.querySelectorAll('.timer-active-switch').forEach(function (elem) {
                        elem.setAttribute("disabled", "disabled");
                    });
                    timersSettingsTimersList.querySelectorAll('.timer-delete').forEach(function (elem) {
                        elem.setAttribute("disabled", "disabled");
                    });
                }

                function enableTimerInputElements() {
                    timersSettingsTimersList.querySelectorAll('.timer-active-switch').forEach(function (elem) {
                        elem.removeAttribute("disabled");
                    });
                    timersSettingsTimersList.querySelectorAll('.timer-delete').forEach(function (elem) {
                        elem.removeAttribute("disabled");
                    });
                }

                function deleteTimer(id) {
                    disableTimerInputElements();
                    ons.notification.confirm('Do you really want to delete this timer?').then(function (answer) {
                        if (answer === 1) {
                            loadingBarSettingsTimers.setAttribute("indeterminate", "indeterminate");

                            fn.request("api/timers/" + id, "DELETE", function (err, res) {
                                if (err) {
                                    ons.notification.toast(err, { buttonLabel: 'Dismiss', timeout: 1500 });
                                }

                                updateSettingsTimersPage();
                            })
                        } else {
                            enableTimerInputElements();
                        }
                    });
                }

                function clearNewTimerDialog() {
                    document.getElementById('add-timer-form').month.value = "";
                    document.getElementById('add-timer-form').day.value = "";
                    document.getElementById('add-timer-form').hour.value = "";
                    document.getElementById('add-timer-form').minute.value = "";
                    var daysRunner;
                    for(daysRunner = 0; daysRunner<document.getElementById('add-timer-form').days.length; daysRunner++) {
                        document.getElementById('add-timer-form').days[daysRunner].checked = false;
                    }
                }

                function addNewTimer() {
                    //get and validate selected month
                    var monthValue = document.getElementById('add-timer-form').month.value;
                    if (monthValue === "") {
                        monthValue = "*";
                    } else {
                        //verify limits of month
                        var monthNumber = parseInt(monthValue)  || 0;
                        if (monthNumber < 1) {
                            monthValue = 1;
                        } else if (monthNumber > 12) {
                            monthValue = 12;
                        }
                    }
                    //get and validate selected day
                    var dayValue = document.getElementById('add-timer-form').day.value;
                    if (dayValue === "") {
                        dayValue = "*";
                    } else {
                        //verify limits of day
                        var dayNumber = parseInt(dayValue)  || 0;
                        if (dayNumber < 1) {
                            dayValue = 1;
                        } else if (dayNumber > 31) {
                            dayValue = 31;
                        }
                    }
                    //get and validate selected hour
                    var hoursValue = document.getElementById('add-timer-form').hour.value;
                    if (hoursValue === "") {
                        hoursValue = "*";
                    } else {
                        //verify limits of hour
                        var hoursNumber = parseInt(hoursValue)  || 0;
                        if (hoursNumber < 0) {
                            hoursValue = 0;
                        } else if (hoursNumber > 23) {
                            hoursValue = hoursNumber % 24;
                        }
                    }
                    //get and validate selected minute
                    var minutesValue = document.getElementById('add-timer-form').minute.value;
                    if (minutesValue === "") {
                        minutesValue = "*";
                    } else {
                        //verify limits of minute
                        var minutesNumber = parseInt(minutesValue)  || 0;
                        if (minutesNumber < 0) {
                            minutesValue = 0;
                        } else if (minutesNumber > 59) {
                            minutesValue = minutesNumber % 60;
                        }
                    }
                    //get and validate selected days
                    var daySelection = "";
                    var daysElementArray =  document.getElementById('add-timer-form').days;
                    var daysTotal = daysElementArray.length;
                    var daysRunner;
                    for(daysRunner = 0; daysRunner<daysTotal; daysRunner++) {
                        if (daysElementArray[daysRunner].checked) {
                            var currentDayValue = daysElementArray[daysRunner].value;
                            if (daySelection === "") {
                                daySelection = currentDayValue;
                            } else {
                                daySelection += ","+currentDayValue
                            }
                        }
                    }
                    if (daySelection === "") {
                        daySelection = "*";
                    }
                    //build cron timer
                    var cronTimer = "" + minutesValue + " " + hoursValue + " " + dayValue + " " + monthValue + " " + daySelection;
                    //save timer
                    fn.requestWithPayload("api/timers", JSON.stringify({ cron: cronTimer }), "POST", function (err, res) {
                        if (err) {
                            ons.notification.toast(err, { buttonLabel: 'Dismiss', timeout: 1500 });
                        }
                        updateSettingsTimersPage();
                    })
                    hideNewTimerDialog();
                }

                //if timerId is set to -1, the timer is deleted
                var showAddTimerDialog = function(timerId) {
                    if (timerId == -1) {
                        clearNewTimerDialog();
                    }
                    document.getElementById('add-timer-dialog').show();
                };

                var hideNewTimerDialog = function() {
                    document.getElementById('add-timer-dialog').hide();
                };

            </script>
            <style>
                .timer-delete {
                    margin-left: 12px;
                    font-size: 2em;
                    color: #eb5959;
                }
            </style>
        </ons-page>
    </template>

    <template id="about.html">
            <ons-page id="about">
                <ons-toolbar>
                    <div class="left">
                        <ons-back-button>Home</ons-back-button>
                    </div>
                    <div class="center">About</div>
                </ons-toolbar>
                <span style="text-align: center;">
                    <h3>Valetudo - Free your vacuum from the cloud</h3>
                    <p>
                        Another IoT Smarthome Node.js project by <a href="https://github.com/Hypfer" target="_blank">Hypfer</a>.
                        <br/>
                        <br/>
                        Thanks to all contributors:
                        <br/>
                        <a style="word-wrap:break-word;" href="https://github.com/Hypfer/Valetudo/graphs/contributors" target="_blank">
                            https://github.com/Hypfer/Valetudo/graphs/contributors
                        </a>
                        <br/>
                        <br/>

                    </p>
                    <p>Made with ♥ for Castrop-Rauxel</p>
                </span>

            </ons-page>
    </template>
</body>
</html>
