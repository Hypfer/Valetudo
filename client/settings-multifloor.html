<ons-page id="settings-multifloor-page">
    <ons-toolbar>
        <div class="left">
            <ons-back-button>Settings</ons-back-button>
        </div>
        <div class="center">MultiFloor</div>
        <div class="right">
        </div>
    </ons-toolbar>
    <ons-progress-bar id="loading-bar-settings-multifloor" value="0" indeterminate="indeterminate"></ons-progress-bar>
    <ons-list-title style="margin-top:5px;">Multi Floor Configuration</ons-list-title>
    <ons-row>
        <ons-col></ons-col>
        <ons-col width="300px" vertical-align='center' style='text-align:center; max-width: 400px;'>Persistent data or "lab mode" is a feature of the Roborock S5x which allows to save no-go areas and virtual walls. It also allows the robot to drive back to the dock wherever it is and keeps the map from being rotated.</ons-col>
        <ons-col></ons-col>
    </ons-row>

    <form id="multifloor_form" class="hidden">
        <ons-row>
            <ons-col></ons-col>
            <ons-col width="150px" vertical-align='center'>Enabled</ons-col>
            <ons-col width="150px" vertical-align='center'><ons-checkbox input-id="multifloor_enabled"></ons-checkbox></ons-col>
            <ons-col></ons-col>
        </ons-row>

        <ons-row>
            <ons-col></ons-col>
            <ons-col width="100px" vertical-align='center'><ons-button modifier="large" class="button-margin" onclick="saveMultiFloor();">Save</ons-button></ons-col>
            <ons-col></ons-col>
        </ons-row>
    </form>

    <style>
        #multifloor_form {
            margin-top: 1em;
        }
    </style>

    <script>
        var loadingBar = document.getElementById('loading-bar-settings-multifloor');

        ons.getScriptPage().onShow = function () {

            updateSettingsPersistentDataPage();
        };

        function initForm(currentStatus) {
            var persistentDataForm = document.getElementById('multifloor_form');
            document.getElementById('multifloor_enabled').checked = (currentStatus.enabled === 1);
        }

        function updateSettingsPersistentDataPage() {
            loadingBar.setAttribute("indeterminate", "indeterminate");
            fn.request("api/get_multifloor", "GET", function (err, res) {
                loadingBar.removeAttribute("indeterminate");
                if (err) {
                    ons.notification.toast(err, { buttonLabel: 'Dismiss', timeout: window.fn.toastErrorTimeout })
                } else {
                    initForm(res);

                }
            })
        }

        function savePersistentData() {
            const labStatus = true === document.getElementById('multifloor_enabled').checked;

            loadingBar.setAttribute("indeterminate", "indeterminate");
            fn.requestWithPayload("api/set_multifloor", JSON.stringify({ lab_status: labStatus }), "PUT", function (err, res) {
                loadingBar.removeAttribute("indeterminate");
                if (err) {
                    ons.notification.toast(err, { buttonLabel: 'Dismiss', timeout: window.fn.toastErrorTimeout });
                } else {
                    ons.notification.toast("Saved settings!", { buttonLabel: 'Dismiss', timeout: window.fn.toastOKTimeout });
                }
            });
        }
    </script>
</ons-page>